<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrackAll - 空运快递海运小包货代单号追踪</title>
    <meta name="description" content="专业的国际物流追踪平台，支持DHL、UPS、FedEx等快递公司和IATA航空货运追踪，提供实时邮件通知服务">
    <meta name="keywords" content="快递追踪,物流查询,DHL追踪,UPS追踪,FedEx追踪,航空货运,空运追踪,海运追踪">
    <meta name="author" content="货代导航网">
    <link rel="canonical" href="https://trackall.huodaiagent.com/">
    
    <!-- 网站图标 -->
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <link rel="shortcut icon" type="image/svg+xml" href="/logo.svg">
    <link rel="apple-touch-icon" href="/logo.svg">
    <link rel="manifest" href="/manifest.json">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Microsoft YaHei', sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 60px 10px 20px;
            overflow-x: hidden;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            width: 95%;
            text-align: center;
            margin-top: 80px;
        }

        .logo {
            font-size: 5rem;
            font-weight: 400;
            color: #000000;
            margin-bottom: 25px;
            letter-spacing: -3px;
        }

        .subtitle {
            font-size: 18px;
            color: #70757a;
            margin-bottom: 40px;
            font-weight: 400;
        }

        .search-container {
            display: flex;
            gap: 30px;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto 60px;
            align-items: flex-start;
        }

        .input-wrapper {
            flex: 1;
            max-width: 800px;
            position: relative;
        }



        .search-box {
            width: 100%;
            min-height: 300px;
            max-height: 500px;
            padding: 25px 25px 60px 25px;
            border: 1px solid #dfe1e5;
            border-radius: 15px;
            font-size: 18px;
            outline: none;
            background: #fff;
            color: #333;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(0,0,0,0.06);
            font-family: inherit;
            line-height: 1.7;
            overflow-y: auto;
            cursor: text;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0;
        }

        .search-box:hover {
            box-shadow: 0 8px 24px rgba(96, 165, 250, 0.15);
            border-color: #60a5fa;
        }

        .search-box:focus {
            box-shadow: 0 8px 24px rgba(96, 165, 250, 0.15);
            border-color: #60a5fa;
        }

        .search-box::placeholder {
            color: #9aa0a6;
        }

        /* 标签样式 - 17track一体化风格 */
        .tracking-tag {
            display: flex;
            align-items: center;
            padding: 12px 12px 12px 3px;
            font-size: 16px;
            line-height: 1.4;
            width: 100%;
            word-break: break-all;
            position: relative;
            transition: all 0.2s ease;
            border: none;
            border-radius: 0;
            margin-bottom: 1px;
        }

        .tracking-tag:hover {
            background: rgba(66, 133, 244, 0.05);
        }

        .tracking-tag .tag-number {
            font-weight: 400;
            margin-right: 10px;
            color: #999;
            font-size: 15px;
            min-width: 16px;
            user-select: none;
        }

        .tracking-tag .tag-content {
            font-weight: 500;
            color: #1a1a1a;
            flex: 1;
            text-align: left;
            user-select: text;
            cursor: text;
        }

        .tracking-tag .tag-remove {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(0,0,0,0.1);
            color: #999;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            opacity: 0;
            user-select: none;
        }

        .tracking-tag:hover .tag-remove {
            opacity: 1;
        }

        .tracking-tag .tag-remove:hover {
            background: #ff4444;
            color: white;
        }

        /* 交替背景色 */
        .tracking-tag:nth-child(odd) {
            background: #f8f9fa;
        }

        .tracking-tag:nth-child(even) {
            background: #ffffff;
        }

        /* 复制提示动画 */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        /* 隐藏的输入框 */
        .hidden-input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
            width: 1px;
            height: 1px;
        }

        /* 输入提示 */
        .input-placeholder {
            color: #9aa0a6;
            font-size: 18px;
            pointer-events: none;
            position: absolute;
            top: 25px;
            left: 25px;
            transition: all 0.2s ease;
            line-height: 1.6;
        }

        .input-placeholder.hidden {
            opacity: 0;
        }

        .placeholder-line {
            margin-bottom: 8px;
        }

        .placeholder-line:last-child {
            margin-bottom: 0;
        }

        /* 临时输入区域 */
        .temp-input {
            min-width: 200px;
            max-width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-size: 18px;
            font-family: inherit;
            color: #333;
            padding: 4px 0;
        }

        .input-actions {
            display: none;
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            gap: 10px;
            z-index: 2;
        }

        .input-actions.show {
            display: flex;
        }

        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 1px solid #dfe1e5;
            border-radius: 6px;
            font-size: 14px;
            color: #5f6368;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            flex: 1;
            height: 40px;
        }

        .action-btn:hover {
            background: #f1f3f4;
            border-color: #4285f4;
            color: #4285f4;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn i {
            font-size: 13px;
        }

        .action-btn span {
            font-size: 14px;
        }

        .search-btn {
            background: #f8f9fa;
            color: #5f6368;
            border: 1px solid #dfe1e5;
            padding: 0 40px;
            height: 300px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            min-width: 180px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .search-btn:hover {
            background: #f1f3f4;
            border-color: #4285f4;
            color: #4285f4;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .search-btn i {
            font-size: 36px;
            position: relative;
            z-index: 5;
        }

        .search-btn span {
            font-size: 18px;
        }

        .tracking-count {
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-left: 75px solid transparent;
            border-top: 75px solid #ffffff;
            display: none;
            z-index: 10;
        }

        .tracking-count.show {
            display: block;
        }

        .tracking-count::after {
            content: attr(data-count);
            position: absolute;
            top: -50px; /* 第一步：明显向上移动 */
            right: -5px; /* 再往左移动 */
            font-size: 20px; /* 调大字体 */
            font-weight: bold;
            line-height: 1;
            color: #5f6368;
            text-shadow: none;
            width: 25px;
            height: 25px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate(-50%, -50%); /* 从自身中心偏移 */
        }



        .results-page {
            min-height: 100vh;
            background: #fafbfc;
            padding: 0;
            width: 100%;
            overflow-x: auto;
        }

        .results-header {
            background: white;
            border-bottom: 1px solid #eaecef;
            padding: 16px 0;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-header h2 {
            font-size: 24px;
            color: #24292f;
            margin: 0;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            background: #0969da;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(9, 105, 218, 0.12);
        }

        .back-btn:hover {
            background: #0860ca;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(9, 105, 218, 0.2);
        }

        .status-summary {
            background: white;
            border-bottom: 1px solid #eaecef;
            padding: 0;
        }

        .summary-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 16px;
            display: flex;
            gap: 0;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: visible;
            position: relative;
        }

        .status-tab {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 24px;
            background: transparent;
            border: none;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #495057;
            position: relative;
            flex: 1;
            justify-content: center;
            border-radius: 0;
            min-height: 84px;
            box-sizing: border-box;
        }



        .status-tab.tab-total {
            background: transparent;
            color: #495057;
            font-weight: 600;
        }

        .status-tab.tab-info {
            background: transparent;
        }

        .status-tab.tab-pickup {
            background: transparent;
        }

        .status-tab.tab-transit {
            background: transparent;
        }

        .status-tab.tab-customs {
            background: transparent;
        }

        .status-tab.tab-exception {
            background: transparent;
        }

        .status-tab.tab-delivery {
            background: transparent;
        }

        .status-tab.tab-delivered {
            background: transparent;
        }

        .status-tab.tab-time-analysis {
            background: transparent;
        }

        .status-tab .icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        /* 17track风格：重点突出图标颜色 */
        .status-tab.tab-total .icon {
            color: #1565c0;
        }

        .status-tab.tab-info .icon {
            color: #0277bd;
        }

        .status-tab.tab-pickup .icon {
            color: #2e7d32;
        }

        .status-tab.tab-transit .icon {
            color: #f57c00;
        }

        .status-tab.tab-customs .icon {
            color: #5d4037;
        }

        .status-tab.tab-exception .icon {
            color: #d32f2f;
        }

        .status-tab.tab-delivery .icon {
            color: #ffa000;
        }

        .status-tab.tab-delivered .icon {
            color: #388e3c;
        }

        .status-tab.tab-time-analysis .icon {
            color: #7b1fa2;
        }

        .status-tab .count {
            background: rgba(255,255,255,0.9);
            color: inherit;
            padding: 7px 14px;
            border-radius: 22px;
            font-size: 15px;
            min-width: 32px;
            text-align: center;
            font-weight: 700;
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            transition: all 0.2s ease;
        }

        .status-tab.tab-total .count {
            background: rgba(255,255,255,0.9);
            color: #1565c0;
            border-color: rgba(255,255,255,0.8);
            font-weight: 800;
        }

        /* 状态栏底部横线 */
        .summary-content::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: var(--line-left, 0);
            width: var(--line-width, 0);
            height: 1px;
            background: rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 1002;
        }

        .summary-content.show-line::after {
            opacity: 1;
        }



        /* 悬停提示框 - 17track风格 */
        .status-tab .tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 10px;
            background: #ffffff;
            color: #333333;
            padding: 20px 24px;
            border-radius: 8px;
            font-size: 15px;
            white-space: normal;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e0e0;
            min-width: 380px;
            max-width: 560px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        /* 全部状态的tooltip需要更宽一些 */
        .status-tab.tab-total .tooltip {
            min-width: 520px;
            max-width: 640px;
            padding: 22px 26px;
            font-size: 15px;
        }

        /* 异常状态的tooltip需要更宽一些 */
        .status-tab.tab-exception .tooltip {
            min-width: 480px;
            max-width: 600px;
            padding: 20px 24px;
        }

        /* 异常状态tooltip的描述文字 */
        .status-tab.tab-exception .tooltip-desc {
            margin-bottom: 16px;
        }

        .status-tab:hover .tooltip {
            display: block;
        }

        .tooltip-title {
            font-weight: 600;
            font-size: 17px;
            margin-bottom: 12px;
            color: #333333;
            border-bottom: 1px solid #e8e8e8;
            padding-bottom: 8px;
        }

        /* 全部状态的tooltip标题样式 */
        .status-tab.tab-total .tooltip-title {
            font-size: 16px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 10px;
            padding-bottom: 8px;
        }

        .tooltip-desc {
            font-size: 15px;
            line-height: 1.6;
            color: #666666;
            margin-bottom: 14px;
            white-space: normal;
            font-weight: 400;
        }

        /* 为全部状态的tooltip添加特殊样式 */
        .status-tab.tab-total .tooltip-desc {
            line-height: 1.6;
            margin-bottom: 0;
            font-size: 15px;
            color: #555555;
            font-weight: 400;
        }

        /* 确保<br>标签在tooltip中正确显示 */
        .tooltip-desc br {
            display: block;
            margin-bottom: 10px;
        }

        .tooltip-states {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .state-item {
            font-size: 14px;
            line-height: 1.5;
            color: #555555;
            padding: 4px 0;
            white-space: normal;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-weight: 400;
        }

        .state-item::before {
            content: "•";
            color: #999999;
            font-size: 14px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        /* 异常状态分类样式 */
        .status-tab.tab-exception .exception-category {
            margin-bottom: 16px;
        }

        .status-tab.tab-exception .exception-category:last-child {
            margin-bottom: 0;
        }

        .status-tab.tab-exception .category-title {
            font-size: 14px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 8px;
            padding-left: 0;
        }

        .status-tab.tab-exception .category-items {
            margin-left: 16px;
        }

        .status-tab.tab-exception .category-items .state-item {
            font-size: 13px;
            line-height: 1.4;
            padding: 2px 0;
        }

        .status-tab.tab-exception .category-items .state-item::before {
            content: "• ";
            color: #999999;
            font-size: 12px;
            margin-top: 1px;
            margin-right: 6px;
            font-family: monospace;
        }

        .status-tab.tab-exception .category-items .state-item:last-child::before {
            content: "• ";
        }

        /* 提示框箭头 */
        .status-tab .tooltip::before {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-bottom-color: #ffffff;
        }

        .results-content {
            max-width: 1632px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        .results-table {
            background: transparent;
            border-radius: 0;
            border: none;
            overflow: visible;
            box-shadow: none;
        }

        .result-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            min-height: 110px;
            transition: all 0.15s ease;
            cursor: pointer;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
        }

        .result-item:hover {
            background: #f9fafb;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border-color: #d1d5db;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-left {
            width: 290px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-shrink: 0;
        }

        .status-icon-main {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        .status-icon-main:hover {
            transform: scale(1.15);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .status-icon-main.info {
            background: #3b82f6;
        }

        .status-icon-main.pickup {
            background: #10b981;
        }

        .status-icon-main.transit {
            background: #f59e0b;
        }

        .status-icon-main.customs {
            background: #8b5cf6;
        }

        .status-icon-main.exception {
            background: #ef4444;
        }

        .status-icon-main.delivery {
            background: #f97316;
        }

        .status-icon-main.delivered {
            background: #22c55e;
        }

        .status-icon-main.time-analysis {
            background: #6366f1;
        }

        .status-icon-pure {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            transition: all 0.15s ease;
            width: 56px;
            height: 56px;
        }

        .status-icon-pure:hover {
            transform: scale(1.08);
        }

        .status-section {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .status-text-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .status-text-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-text {
            font-size: 18px;
            font-weight: 500;
            color: #1a1a1a;
            line-height: 1.3;
        }

        .status-time {
            font-size: 16px;
            color: #9ca3af;
            font-weight: 400;
        }

        .tracking-section {
            margin-top: 0;
        }



        .carrier-info {
            position: relative;
            flex-shrink: 0;
        }

        .carrier-name {
            font-size: 18px;
            font-weight: 600;
            color: #0066cc !important;
            line-height: 1.2;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.15s ease;
            display: inline-block;
        }

        .carrier-name:hover {
            background: #f0f9ff;
            color: #0052a3;
        }

        .carrier-name.error {
            color: #dc3545;
        }

        .carrier-name.error:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .carrier-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 150px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.15s ease;
        }

        .carrier-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .carrier-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            color: #374151;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
        }

        .carrier-menu-item:hover {
            background: #f9fafb;
            color: #1f2937;
        }

        .carrier-menu-item i {
            font-size: 12px;
            width: 16px;
            text-align: center;
            color: #6b7280;
        }

        /* 服务商选择弹窗样式 */
        .carrier-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .carrier-modal.show {
            display: flex;
        }

        .carrier-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .carrier-modal-header {
            background: #3b82f6;
            color: white;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .carrier-modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .carrier-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.15s ease;
        }

        .carrier-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .carrier-search-container {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .carrier-current-selection {
            padding: 12px 16px;
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .current-selection-text {
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .tracking-number-display {
            font-weight: 600;
            color: #3b82f6;
        }

        .current-selection-hint {
            font-size: 12px;
            color: #6b7280;
        }

        .carrier-search-box {
            width: 100%;
            padding: 12px 16px 12px 48px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            background: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%236b7280"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>') no-repeat 16px center;
            background-size: 20px;
        }

        .carrier-search-box:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .carrier-modal-body {
            padding: 20px 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .carrier-category {
            margin-bottom: 24px;
        }

        .carrier-category:last-child {
            margin-bottom: 0;
        }

        .carrier-category-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .carrier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .carrier-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            color: #374151;
        }

        .carrier-item:hover {
            background: #f9fafb;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .carrier-item-icon {
            width: 24px;
            height: 24px;
            background: #f3f4f6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
        }

        .carrier-item-name {
            font-size: 14px;
            font-weight: 500;
        }

        .carrier-no-results {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            font-size: 16px;
        }

        @media (max-width: 768px) {
            .carrier-modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .carrier-grid {
                grid-template-columns: 1fr;
            }
        }

        .tracking-info {
            flex: 1;
            min-width: 0;
        }

        .tracking-number {
            font-size: 16px;
            color: #6b7280;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Microsoft YaHei', sans-serif;
            margin-top: 6px;
            letter-spacing: 0.2px;
        }



        .result-middle {
            flex: 1;
            padding: 0 32px;
            display: flex;
            align-items: center;
            gap: 32px;
            min-width: 0;
        }

        .location-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .tracking-timeline {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
            margin-left: 8px;
        }

        .tracking-time {
            font-weight: 500;
            color: #333;
        }

        .tracking-location {
            color: #666;
        }

        .tracking-description {
            color: #888;
            font-style: italic;
        }

        /* 17track风格轨迹明细样式 */
        .tracking-details {
            background: #fff;
            border-radius: 8px;
            margin-top: 16px;
            border: 1px solid #e1e4e8;
            overflow: hidden;
        }

        .tracking-details-header {
            background: #f6f8fa;
            padding: 16px 20px;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .carrier-icon-large {
            width: 24px;
            height: 24px;
            background: #ff6600;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .carrier-icon-large.dhl {
            background: #d40511;
        }

        .carrier-icon-large.ups {
            background: #8b4513;
        }

        .carrier-icon-large.fedex {
            background: #4d148c;
        }

        .tracking-details-title {
            flex: 1;
        }

        .tracking-details-carrier {
            font-size: 16px;
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 2px;
        }

        .tracking-details-subtitle {
            font-size: 12px;
            color: #5f6368;
        }

        .tracking-details-contact {
            font-size: 12px;
            color: #1a73e8;
            text-decoration: none;
        }

        .tracking-details-contact:hover {
            text-decoration: underline;
        }

        .tracking-timeline-container {
            padding: 0;
        }

        .tracking-timeline-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #e8eaed;
            transition: background-color 0.15s ease;
            min-height: 60px;
        }

        .tracking-timeline-item:hover {
            background-color: #f8f9fa;
        }

        .tracking-timeline-item:last-child {
            border-bottom: none;
        }

        .tracking-timeline-item.latest {
            background-color: #e8f0fe;
            border-left: 3px solid #1a73e8;
        }

        .timeline-icon-container {
            width: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 16px;
        }

        .timeline-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9aa0a6;
            position: relative;
            z-index: 2;
        }

        .timeline-icon.latest {
            background: #1a73e8;
            width: 10px;
            height: 10px;
        }

        .timeline-icon.delivered {
            background: #34a853;
        }

        .timeline-line {
            width: 1px;
            height: 100%;
            background: #e8eaed;
            margin-top: 4px;
            flex: 1;
        }

        .timeline-content {
            flex: 1;
            min-width: 0;
        }

        .timeline-datetime {
            font-size: 14px;
            color: #202124;
            font-weight: 500;
            margin-right: 20px;
            min-width: 160px;
            white-space: nowrap;
        }

        .timeline-location {
            font-size: 13px;
            color: #1a73e8;
            font-weight: 500;
            margin-right: 20px;
            min-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .timeline-description {
            font-size: 13px;
            color: #5f6368;
            line-height: 1.4;
            flex: 1;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .tracking-details-header {
                padding: 12px 16px;
            }
            
            .tracking-timeline-item {
                padding: 12px 16px;
            }
            
            .timeline-icon-container {
                width: 32px;
                margin-right: 12px;
            }
            
            .timeline-datetime,
            .timeline-location,
            .timeline-description {
                font-size: 12px;
            }
        }

        .location-from {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .location-arrow {
            color: #999;
            font-size: 16px;
            font-weight: 400;
        }

        .location-to {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .result-right {
            width: 320px;
            text-align: right;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        /* 17track风格的展开/收起按钮 - 纯符号版 */
        .toggle-details-btn {
            cursor: pointer;
            font-size: 16px;
            color: #9aa0a6;
            user-select: none;
            padding: 4px;
            transition: color 0.2s ease;
        }

        .toggle-details-btn:hover {
            color: #1a73e8;
        }

        .toggle-details-btn .toggle-symbol {
            font-weight: normal;
        }

        .status-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .status-delivered { 
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status-in-transit { 
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .status-picked-up { 
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .status-at-warehouse { 
            background: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c4b5fd;
        }

        .last-update {
            font-size: 14px;
            color: #656d76;
            line-height: 1.4;
            max-width: 320px;
            word-wrap: break-word;
        }

        .result-details {
            background: #f6f8fa;
            border-top: 1px solid #e1e4e8;
            padding: 20px;
            display: none;
        }

        .result-details.expanded {
            display: block;
        }

        .details-timeline {
            max-width: 800px;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e1e4e8;
        }

        .timeline-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .timeline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #0366d6;
            margin-top: 6px;
            flex-shrink: 0;
        }

        .timeline-dot.latest {
            background: #28a745;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-date {
            font-size: 14px;
            color: #24292e;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .timeline-location {
            font-size: 13px;
            color: #656d76;
            margin-bottom: 2px;
        }

        .timeline-description {
            font-size: 13px;
            color: #24292e;
            line-height: 1.4;
        }

        .error-item .result-middle {
            color: #cf222e;
        }

        .error-message {
            color: #cf222e;
            font-size: 15px;
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            padding: 120px 40px;
            color: #656d76;
            font-size: 18px;
            background: white;
            border-radius: 12px;
            border: 1px solid #d0d7de;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .results {
            margin-top: 60px;
            text-align: left;
        }

        .result-card {
            background: white;
            border: 1px solid #dadce0;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            min-height: 128px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .carrier-info {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .carrier-logo {
            width: 50px;
            height: 50px;
            background: #4285f4;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .carrier-name {
            font-size: 22px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }

        .tracking-number {
            font-size: 15px;
            color: #5f6368;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-delivered { 
            background: #e8f5e8;
            color: #137333;
        }
        .status-in-transit { 
            background: #e3f2fd;
            color: #1565c0;
        }
        .status-picked-up { 
            background: #fff3e0;
            color: #ef6c00;
        }
        .status-at-warehouse { 
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .timeline {
            border-left: 4px solid #e8eaed;
            margin-left: 12px;
            padding-left: 35px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-bottom: 18px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -42px;
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4285f4;
            border: 4px solid white;
            box-shadow: 0 0 0 2px #e8eaed;
        }

        .timeline-item:first-child::before {
            background: #34a853;
            box-shadow: 0 0 0 2px #e8eaed;
        }

        .timeline-date {
            font-size: 14px;
            color: #5f6368;
            margin-bottom: 6px;
        }

        .timeline-location {
            font-weight: 500;
            color: #202124;
            margin-bottom: 6px;
            font-size: 16px;
        }

        .timeline-description {
            color: #5f6368;
            font-size: 15px;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 80px 20px;
            color: #5f6368;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        .spinner-small {
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fce8e6;
            color: #d93025;
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            font-size: 16px;
            border-left: 6px solid #d93025;
        }

        @media (max-width: 1024px) {
            .container {
                max-width: 95%;
                margin-top: 60px;
            }

            .logo {
                font-size: 4.2rem;
            }

            .search-container {
                max-width: 100%;
                gap: 25px;
            }

            .search-box {
                height: 200px;
                font-size: 17px;
            }

            .search-btn {
                height: 200px;
                min-width: 140px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 30px 15px 20px;
            }

            .container {
                margin-top: 30px;
            }

            .logo {
                font-size: 3.5rem;
                margin-bottom: 20px;
                letter-spacing: -2px;
            }

            .subtitle {
                font-size: 16px;
                margin-bottom: 50px;
            }

            .search-container {
                flex-direction: column;
                max-width: 95%;
                gap: 25px;
            }

            .input-wrapper {
                width: 100%;
            }

            .search-box {
                height: 240px;
                font-size: 16px;
                padding: 20px 20px 55px 20px;
            }

            .search-btn {
                height: 80px;
                flex-direction: row;
                font-size: 18px;
                min-width: auto;
                width: 100%;
            }

            .search-btn i {
                font-size: 20px;
            }

            .search-btn span {
                font-size: 18px;
            }

            .input-actions {
                position: absolute;
                bottom: 12px;
                left: 12px;
                right: 12px;
                gap: 8px;
            }

            .input-actions.show {
                display: flex;
            }

            .action-btn {
                justify-content: center;
                padding: 10px 12px;
                font-size: 13px;
                height: 36px;
                flex: 1;
            }

            .action-btn i {
                font-size: 13px;
            }

            .action-btn span {
                font-size: 13px;
            }

            .result-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .result-card {
                padding: 25px 20px;
            }

            .results-page {
                padding: 0;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                padding: 16px 20px;
            }

            .results-header h2 {
                font-size: 24px;
            }

            .back-btn {
                align-self: flex-start;
                padding: 10px 20px;
                font-size: 15px;
            }

            /* 移动端结果展示样式 */
            .carrier-name {
                font-size: 16px;
                padding: 6px 10px;
            }

            .carrier-menu {
                min-width: 130px;
                left: -10px;
            }

            .carrier-menu-item {
                padding: 8px 12px;
                font-size: 13px;
            }

            .carrier-menu-item i {
                font-size: 11px;
                width: 14px;
            }



            .result-left {
                width: 220px;
                gap: 10px;
            }

            .status-icon-main {
                width: 48px;
                height: 48px;
                font-size: 22px;
            }

            .status-icon-pure {
                font-size: 36px;
            }

            .status-text {
                font-size: 14px;
            }

            .status-time {
                font-size: 11px;
            }



            .result-item {
                min-height: 120px;
                padding: 16px 12px;
            }

            .result-middle {
                padding: 0 16px;
                flex: 1;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .location-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                width: 100%;
            }

            .tracking-info {
                width: 100%;
            }

            .result-right {
                width: 200px;
            }

            .results-content {
                padding: 16px 12px;
            }

            .summary-content {
                flex-wrap: nowrap;
                gap: 0;
                padding: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 20px;
            }

            .status-tab {
                font-size: 13px;
                padding: 14px 12px;
                white-space: nowrap;
                flex: 1;
                min-width: 100px;
                flex-shrink: 0;
                min-height: 74px;
            }

            .status-tab .icon {
                font-size: 32px;
                width: 44px;
                height: 44px;
            }

            .status-tab .count {
                font-size: 13px;
                padding: 5px 12px;
                min-width: 28px;
            }

            .status-tab .tooltip {
                font-size: 14px;
                padding: 14px 18px;
                bottom: 130%;
                white-space: normal;
                max-width: 380px;
                min-width: 300px;
                text-align: left;
                line-height: 1.5;
                border-radius: 6px;
                box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
                border: 1px solid #e0e0e0;
                background: #ffffff;
                color: #333333;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            }

            /* 移动端全部状态的tooltip需要更宽一些 */
            .status-tab.tab-total .tooltip {
                min-width: 340px;
                max-width: 420px;
                padding: 18px 22px;
                font-size: 14px;
            }

            /* 移动端全部状态的tooltip文本样式 */
            .status-tab.tab-total .tooltip-desc {
                line-height: 1.5;
                margin-bottom: 0;
                font-size: 14px;
                color: #555555;
                font-weight: 400;
            }

            /* 移动端全部状态的tooltip标题样式 */
            .status-tab.tab-total .tooltip-title {
                font-size: 15px;
                font-weight: 600;
                color: #333333;
                margin-bottom: 8px;
                padding-bottom: 6px;
            }

            /* 移动端<br>标签间距 */
            .tooltip-desc br {
                margin-bottom: 8px;
            }

            /* 移动端异常状态的tooltip */
            .status-tab.tab-exception .tooltip {
                min-width: 320px;
                max-width: 420px;
                padding: 16px 20px;
            }

            /* 移动端异常状态tooltip的描述文字 */
            .status-tab.tab-exception .tooltip-desc {
                margin-bottom: 12px;
            }

            /* 移动端异常状态分类样式 */
            .status-tab.tab-exception .exception-category {
                margin-bottom: 12px;
            }

            .status-tab.tab-exception .category-title {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .status-tab.tab-exception .category-items {
                margin-left: 12px;
            }

            .status-tab.tab-exception .category-items .state-item {
                font-size: 12px;
                line-height: 1.3;
                padding: 1px 0;
            }

            .status-tab.tab-exception .category-items .state-item::before {
                font-size: 11px;
                margin-right: 4px;
            }



            .results-content {
                padding: 16px 20px;
            }

            .result-item {
                flex-direction: column;
                min-height: 120px;
                align-items: stretch;
                padding: 20px;
                margin-bottom: 6px;
            }

            .result-left {
                width: 100%;
                margin-bottom: 16px;
                justify-content: flex-start;
                flex-wrap: wrap;
            }

            .carrier-icon {
                width: 40px;
                height: 40px;
            }

            .status-icon-pure {
                font-size: 32px;
            }

            .status-text {
                font-size: 13px;
            }

            .status-time {
                font-size: 10px;
            }



            .tracking-number {
                font-size: 16px;
            }

            .result-middle {
                padding: 0;
                margin-bottom: 16px;
                justify-content: flex-start;
            }

            .location-from,
            .location-to {
                font-size: 15px;
            }

            .location-arrow {
                font-size: 16px;
            }

            .result-right {
                width: 100%;
                text-align: left;
            }

            .status-info {
                align-items: flex-start;
            }

            .status-badge {
                padding: 6px 14px;
                font-size: 12px;
            }

            .last-update {
                max-width: 100%;
                font-size: 13px;
            }

            .result-details {
                padding: 20px;
            }

            .timeline-item {
                margin-bottom: 16px;
                padding-bottom: 16px;
            }
        }

        .notify-btn {
            margin-left: 12px;
            margin-right: 12px;
            cursor: pointer;
            color: #3b82f6;
            font-size: 22px;
            transition: color 0.2s;
            display: inline-block;
        }
        .notify-btn:hover {
            color: #f59e0b;
        }
        
        /* 预计到达时间和最新轨迹样式 - 与起运地到目的地字体一致 */
        .delivery-info {
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 24px;
            font-size: 16px;
            color: #5f6368;
        }
        
        .estimated-delivery {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: #e8f0fe;
            border-radius: 4px;
            border: 1px solid #dadce0;
        }
        
        .estimated-delivery .delivery-label {
            color: #1a73e8;
            font-weight: 500;
            font-size: 16px;
        }
        
        .estimated-delivery .delivery-date {
            color: #1a73e8;
            font-weight: 600;
            font-size: 16px;
        }
        
        .latest-event {
            display: flex;
            align-items: center;
            gap: 0;
            max-width: 300px;
            overflow: hidden;
            padding: 2px 0;
            margin-left: 0;
        }
        
        .latest-event .event-description {
            color: #5f6368;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            font-weight: 400;
        }
        
        /* 移除不需要的样式 */
        .latest-event .event-time,
        .latest-event .event-location {
            display: none;
        }
        
        /* 响应式调整 - 与起运地到目的地保持一致 */
        @media (max-width: 1200px) {
            .delivery-info {
                gap: 24px;
                font-size: 15px;
            }
            .estimated-delivery .delivery-label,
            .estimated-delivery .delivery-date {
                font-size: 15px;
            }
            .latest-event .event-description {
                font-size: 15px;
            }
            .latest-event {
                max-width: 200px;
            }
            .latest-event .event-location {
                max-width: 60px;
            }
            .latest-event .event-time {
                min-width: 70px;
            }
        }
        .notify-modal {
            display: none;
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }
        .notify-modal.show {
            display: flex;
        }
        .notify-modal-content {
            background: #fff;
            border-radius: 12px;
            width: 520px;
            max-width: 90vw;
            max-height: 90vh;
            box-shadow: 0 20px 64px rgba(0,0,0,0.15);
            padding: 0;
            overflow: hidden;
        }
        .notify-modal-header {
            background: linear-gradient(135deg, #855B00 0%, #FFD700 100%);
            color: #fff;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .notify-modal-title {
            flex: 1;
        }
        .notify-modal-title span {
            font-size: 24px;
            font-weight: 700;
            display: block;
        }
        .notify-modal-subtitle {
            font-size: 16px;
            font-weight: 400;
            margin-top: 4px;
            opacity: 0.9;
        }
        .notify-modal-actions-top {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .notify-login-btn {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .notify-login-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .notify-modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }
        .notify-modal-body {
            padding: 32px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .notify-section {
            margin-bottom: 32px;
        }
        .notify-section:last-child {
            margin-bottom: 0;
        }
        .notify-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
        }
        .notify-type-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .notify-type-option {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
        }
        .notify-type-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }
        .notify-emails-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        .email-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .email-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .email-error-message {
            color: #ef4444;
            font-size: 12px;
            margin-left: 4px;
            display: none;
        }
        .email-error-message.show {
            display: block;
        }
        .notify-email-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .notify-email-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .notify-email-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .notify-email-input.error:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        .notify-email-input.valid {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .notify-email-input.valid:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .email-remove-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            position: relative;
            font-family: 'Arial', sans-serif;
        }
        .email-remove-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.4);
        }
        .email-remove-btn:active {
            transform: scale(0.95);
        }
        .email-remove-btn::before {
            content: '✕';
            font-size: 12px;
            font-weight: 800;
            line-height: 1;
        }

        .form-group {
            flex: 1;
        }
        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
            display: block;
        }
        .form-select, .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .add-email-btn {
            background: none;
            border: 2px dashed #3b82f6;
            color: #3b82f6;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 12px auto 0;
            position: relative;
        }
        .add-email-btn:hover {
            background: #f0f9ff;
            border-color: #2563eb;
            color: #2563eb;
            transform: scale(1.05);
            border-style: solid;
        }
        .add-email-btn:active {
            transform: scale(0.95);
        }

        .notify-quota-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        .quota-warning-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .quota-warning-content i {
            color: #f59e0b;
            font-size: 18px;
        }
        .quota-warning-content span {
            flex: 1;
            font-size: 14px;
            color: #92400e;
        }
        .quota-recharge-btn {
            background: #f59e0b;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
        }
        .notify-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
        }
        .notify-submit-btn {
            background: #855B00;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .notify-submit-btn:hover {
            background: #6b4600;
        }
        .notify-cancel-btn {
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 8px;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .notify-cancel-btn:hover {
            background: #e5e7eb;
        }

        /* 登录注册弹窗样式 */
        .login-modal {
            display: none;
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 25000;
            align-items: center;
            justify-content: center;
        }
        .login-modal.show {
            display: flex;
        }
        .login-modal-content {
            background: #fff;
            border-radius: 16px;
            width: 440px;
            max-width: 90vw;
            max-height: 90vh;
            box-shadow: 0 24px 64px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .login-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 28px 32px;
            text-align: center;
            position: relative;
        }
        .login-modal-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .login-modal-title span {
            font-size: 28px;
            font-weight: 700;
        }
        .login-modal-subtitle {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.9;
        }
        .login-modal-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .login-modal-close:hover {
            background: rgba(255,255,255,0.1);
        }
        .login-modal-body {
            padding: 36px 32px;
        }
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        .form-input {
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            background: #fff;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-input.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .form-input.valid {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .password-input-wrapper {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 8px;
            font-size: 16px;
            transition: color 0.2s;
        }
        .password-toggle:hover {
            color: #667eea;
        }
        .input-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        .input-error.show {
            display: block;
        }
        .checkbox-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
            line-height: 1.5;
            cursor: pointer;
        }
        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }
        .checkbox-wrapper a {
            color: #667eea;
            text-decoration: none;
        }
        .checkbox-wrapper a:hover {
            text-decoration: underline;
        }
        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .auth-submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .auth-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .auth-submit-btn:active {
            transform: translateY(0);
        }
        .auth-submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .auth-links {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .auth-links a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
        }
        .auth-links a:hover {
            color: #5a67d8;
            text-decoration: underline;
        }
                 @media (max-width: 480px) {
             .login-modal-content {
                 width: 95vw;
                 margin: 20px;
             }
             .login-modal-header {
                 padding: 24px 20px;
             }
             .login-modal-body {
                 padding: 24px 20px;
             }
             .auth-links {
                 flex-direction: column;
                 align-items: center;
                 gap: 12px;
             }
         }

         /* 个人中心弹窗样式 */
         .user-center-modal {
             display: none;
             position: fixed;
             left: 0; top: 0; right: 0; bottom: 0;
             background: rgba(0,0,0,0.5);
             z-index: 25000;
             align-items: center;
             justify-content: center;
         }
         .user-center-modal.show {
             display: flex;
         }
         .user-center-modal-content {
             background: #fff;
             border-radius: 16px;
             width: 600px;
             max-width: 90vw;
             max-height: 90vh;
             box-shadow: 0 24px 64px rgba(0,0,0,0.2);
             overflow: hidden;
         }
         .user-center-modal-header {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: #fff;
             padding: 28px 32px;
             text-align: center;
             position: relative;
         }
         .user-center-title {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 8px;
         }
         .user-center-title span {
             font-size: 28px;
             font-weight: 700;
         }
         .user-center-subtitle {
             font-size: 14px;
             font-weight: 400;
             opacity: 0.9;
         }
         .user-center-modal-close {
             position: absolute;
             top: 20px;
             right: 24px;
             background: none;
             border: none;
             color: #fff;
             font-size: 28px;
             cursor: pointer;
             padding: 4px;
             border-radius: 50%;
             transition: all 0.2s;
         }
         .user-center-modal-close:hover {
             background: rgba(255,255,255,0.1);
         }
         .user-center-modal-body {
             padding: 32px;
             max-height: 70vh;
             overflow-y: auto;
         }

         /* 用户信息卡片 */
         .user-info-card {
             display: flex;
             align-items: center;
             gap: 20px;
             background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
             border: 1px solid #e2e8f0;
             border-radius: 12px;
             padding: 24px;
             margin-bottom: 32px;
         }
         .user-avatar {
             font-size: 64px;
             color: #667eea;
         }
         .user-details {
             flex: 1;
         }
         .user-email {
             font-size: 20px;
             font-weight: 600;
             color: #2d3748;
             margin-bottom: 4px;
         }
         .user-member-since {
             font-size: 14px;
             color: #718096;
         }

         /* 通用区块样式 */
         .section-title {
             display: flex;
             align-items: center;
             gap: 12px;
             font-size: 18px;
             font-weight: 600;
             color: #2d3748;
             margin-bottom: 20px;
             position: relative;
         }
         .section-title i {
             color: #667eea;
             font-size: 20px;
         }
         .view-all-btn {
             background: none;
             border: none;
             color: #667eea;
             font-size: 14px;
             cursor: pointer;
             margin-left: auto;
             padding: 4px 8px;
             border-radius: 4px;
             transition: all 0.2s;
         }
         .view-all-btn:hover {
             background: #f7fafc;
             color: #5a67d8;
         }

         /* 账户余额 */
         .balance-section {
             margin-bottom: 32px;
         }
         .balance-cards {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 20px;
         }
         .balance-card {
             background: #fff;
             border: 1px solid #e2e8f0;
             border-radius: 12px;
             padding: 24px;
             text-align: center;
             transition: all 0.2s;
         }
         .balance-card:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 25px rgba(0,0,0,0.08);
         }
         .balance-label {
             font-size: 14px;
             color: #718096;
             margin-bottom: 8px;
         }
         .balance-amount {
             font-size: 32px;
             font-weight: 700;
             color: #2d3748;
             margin-bottom: 16px;
         }
         .balance-amount.notify-count {
             color: #38a169;
         }
         .balance-note {
             font-size: 12px;
             color: #a0aec0;
         }
         .recharge-card {
             background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
             border-color: #667eea !important;
         }
         .recharge-description {
             font-size: 14px;
             color: #667eea;
             margin-bottom: 16px;
             font-weight: 500;
         }
         .recharge-btn {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: #fff;
             border: none;
             border-radius: 8px;
             padding: 10px 20px;
             font-size: 14px;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.2s;
             display: flex;
             align-items: center;
             gap: 6px;
             margin: 0 auto;
         }
         .recharge-btn:hover {
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
         }

         /* 套餐信息 */
         .package-section {
             margin-bottom: 32px;
         }
         .package-card {
             background: #fff;
             border: 1px solid #e2e8f0;
             border-radius: 12px;
             padding: 24px;
         }
         .package-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 16px;
         }
         .package-name {
             font-size: 18px;
             font-weight: 600;
             color: #2d3748;
         }
         .package-status {
             padding: 4px 12px;
             border-radius: 12px;
             font-size: 12px;
             font-weight: 600;
             text-transform: uppercase;
         }
         .package-status.active {
             background: #c6f6d5;
             color: #22543d;
         }
         .package-details {
             margin-bottom: 16px;
         }
         .package-feature {
             display: flex;
             align-items: center;
             gap: 8px;
             margin-bottom: 8px;
             font-size: 14px;
         }
         .package-feature i.fa-check {
             color: #38a169;
         }
         .package-feature i.fa-times {
             color: #e53e3e;
         }
         .package-expire {
             font-size: 14px;
             color: #718096;
             margin-bottom: 16px;
         }
         .upgrade-btn {
             background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
             color: #fff;
             border: none;
             border-radius: 8px;
             padding: 10px 20px;
             font-size: 14px;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.2s;
         }
         .upgrade-btn:hover {
             transform: translateY(-1px);
             box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
         }

         /* 使用统计 */
         .stats-section {
             margin-bottom: 32px;
         }
         .stats-grid {
             display: grid;
             grid-template-columns: repeat(4, 1fr);
             gap: 16px;
         }
         .stat-item {
             background: #fff;
             border: 1px solid #e2e8f0;
             border-radius: 12px;
             padding: 20px;
             text-align: center;
             transition: all 0.2s;
         }
         .stat-item:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 25px rgba(0,0,0,0.08);
         }
         .stat-number {
             font-size: 28px;
             font-weight: 700;
             color: #667eea;
             margin-bottom: 8px;
         }
         .stat-label {
             font-size: 14px;
             color: #718096;
         }

         /* 历史记录 */
         .history-section {
             margin-bottom: 32px;
         }
         .history-list {
             background: #fff;
             border: 1px solid #e2e8f0;
             border-radius: 12px;
             overflow: hidden;
         }
         .history-item {
             display: flex;
             align-items: center;
             gap: 16px;
             padding: 20px;
             border-bottom: 1px solid #f7fafc;
             transition: all 0.2s;
         }
         .history-item:last-child {
             border-bottom: none;
         }
         .history-item:hover {
             background: #f7fafc;
         }
         .history-icon {
             width: 48px;
             height: 48px;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 20px;
         }
         .history-icon.recharge {
             background: #c6f6d5;
             color: #38a169;
         }
         .history-icon.purchase {
             background: #bee3f8;
             color: #3182ce;
         }
         .history-icon.notify {
             background: #fed7d7;
             color: #e53e3e;
         }
         .history-details {
             flex: 1;
         }
         .history-action {
             font-size: 16px;
             font-weight: 600;
             color: #2d3748;
             margin-bottom: 4px;
         }
         .history-time {
             font-size: 14px;
             color: #718096;
         }
         .history-amount {
             font-size: 16px;
             font-weight: 600;
         }
         .history-amount.positive {
             color: #38a169;
         }
         .history-amount.negative {
             color: #e53e3e;
         }
         .history-amount.usage {
             color: #d69e2e;
         }

         /* 操作按钮 */
         .user-center-actions {
             text-align: center;
         }
         .logout-btn {
             background: #e2e8f0;
             color: #718096;
             border: none;
             border-radius: 8px;
             padding: 12px 24px;
             font-size: 16px;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.2s;
             display: inline-flex;
             align-items: center;
             gap: 8px;
         }
         .logout-btn:hover {
             background: #cbd5e0;
             color: #4a5568;
         }

         /* 响应式设计 */
         @media (max-width: 768px) {
             .user-center-modal-content {
                 width: 95vw;
                 margin: 20px;
             }
             .user-center-modal-header {
                 padding: 24px 20px;
             }
             .user-center-modal-body {
                 padding: 24px 20px;
             }
             .balance-cards {
                 grid-template-columns: 1fr;
             }
             .stats-grid {
                 grid-template-columns: repeat(2, 1fr);
             }
             .user-info-card {
                 flex-direction: column;
                 text-align: center;
                 gap: 16px;
             }
             .user-details {
                 text-align: center;
             }
         }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">Track All</div>
        <div class="subtitle">支持国际空运&nbsp;快递&nbsp;海运&nbsp;专线&nbsp;小包&nbsp;货代单号追踪</div>
        
        <form id="trackingForm">
            <div class="search-container">
                <div class="input-wrapper">
                    <div id="trackingNumbers" class="search-box" tabindex="0">
                        <div class="input-placeholder">
                            <div class="placeholder-line">每行输入一个单号，最多只允许提交40个单号</div>
                            <div class="placeholder-line">支持航空查询，格式：123-12345678。</div>
                        </div>
                    </div>
                    <textarea id="hiddenTextarea" class="hidden-input"></textarea>
                    <div class="input-actions">
                        <button type="button" id="filterButton" class="action-btn">
                            <i class="fas fa-filter"></i>
                            <span>筛选单号</span>
                        </button>
                        <button type="button" id="clearButton" class="action-btn">
                            <i class="fas fa-trash"></i>
                            <span>删除所有</span>
                        </button>
                    </div>
                </div>
                <button type="submit" id="queryButton" class="search-btn">
                    <i class="fas fa-search"></i>
                    <span>查询</span>
                    <span id="trackingCount" class="tracking-count"></span>
                </button>
            </div>
        </form>

        <div id="results" class="results"></div>
    </div>

    <!-- 服务商选择弹窗 -->
    <div id="carrierModal" class="carrier-modal">
        <div class="carrier-modal-content">
            <div class="carrier-modal-header">
                <div class="carrier-modal-title">选择服务商</div>
                <button class="carrier-modal-close" onclick="closeCarrierModal()">×</button>
            </div>
            <div class="carrier-search-container">
                <div class="carrier-current-selection" id="currentSelection" style="display: none;">
                    <div class="current-selection-text">当前查询：<span class="tracking-number-display"></span></div>
                    <div class="current-selection-hint">请选择服务商重新查询</div>
                </div>
                <input type="text" class="carrier-search-box" placeholder="搜索" oninput="filterCarriers(this.value)">
            </div>
            <div class="carrier-modal-body" id="carrierModalBody">
                <!-- 动态内容将通过JavaScript填充 -->
            </div>
        </div>
    </div>

    <!-- 个人中心弹窗 -->
    <div id="userCenterModal" class="user-center-modal">
        <div class="user-center-modal-content">
            <div class="user-center-modal-header">
                <div class="user-center-title">
                    <span>个人中心</span>
                    <div class="user-center-subtitle">管理您的账户和通知服务</div>
                </div>
                <button class="user-center-modal-close" onclick="closeUserCenterModal()">×</button>
            </div>
            <div class="user-center-modal-body">
                <!-- 用户信息卡片 -->
                <div class="user-info-card">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-email" id="userEmailDisplay">user@example.com</div>
                        <div class="user-member-since" id="userMemberSince">注册时间：2024年1月15日 14:30</div>
                    </div>
                </div>

                <!-- 账户余额 -->
                <div class="balance-section">
                    <div class="section-title">
                        <i class="fas fa-bell"></i>
                        账户余额
                    </div>
                    <div class="balance-cards">
                        <div class="balance-card">
                            <div class="balance-label">剩余通知次数</div>
                            <div class="balance-amount notify-count"><span id="notifyCount">156</span> 次</div>
                            <div class="balance-note">总计已使用 <span id="totalUsed">24</span> 次</div>
                        </div>
                        <div class="balance-card recharge-card">
                            <div class="balance-label">购买通知次数</div>
                            <div class="recharge-description">选择适合的次数套餐</div>
                            <button class="recharge-btn" onclick="showRechargeModal()">
                                <i class="fas fa-shopping-cart"></i> 购买套餐
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 套餐信息 -->
                <div class="package-section">
                    <div class="section-title">
                        <i class="fas fa-box"></i>
                        我的套餐
                    </div>
                    <div class="current-package">
                        <div class="package-card">
                            <div class="package-header">
                                <div class="package-name">基础套餐</div>
                                <div class="package-status active">使用中</div>
                            </div>
                            <div class="package-details">
                                <div class="package-feature">
                                    <i class="fas fa-check"></i>
                                    已购买 200 次通知服务
                                </div>
                                <div class="package-feature">
                                    <i class="fas fa-check"></i>
                                    支持邮件通知
                                </div>
                                <div class="package-feature">
                                    <i class="fas fa-times"></i>
                                    不支持短信通知
                                </div>
                            </div>
                            <div class="package-expire">套餐说明：购买次数永久有效，用完为止</div>
                            <button class="upgrade-btn" onclick="showPackageModal()">购买更多次数</button>
                        </div>
                    </div>
                </div>

                <!-- 使用统计 -->
                <div class="stats-section">
                    <div class="section-title">
                        <i class="fas fa-chart-bar"></i>
                        使用统计
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number">342</div>
                            <div class="stat-label">总查询次数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">28</div>
                            <div class="stat-label">设置通知数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">12</div>
                            <div class="stat-label">本月查询</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">5</div>
                            <div class="stat-label">活跃追踪</div>
                        </div>
                    </div>
                </div>

                <!-- 充值记录 -->
                <div class="history-section">
                    <div class="section-title">
                        <i class="fas fa-history"></i>
                        最近记录
                        <button class="view-all-btn" onclick="showFullHistory()">查看全部</button>
                    </div>
                    <div class="history-list">
                        <div class="history-item">
                            <div class="history-icon purchase">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-action">购买标准套餐</div>
                                <div class="history-time">2024/01/15 14:30</div>
                            </div>
                            <div class="history-amount positive">+800 次</div>
                        </div>
                        <div class="history-item">
                            <div class="history-icon purchase">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-action">购买基础套餐</div>
                                <div class="history-time">2024/01/10 09:15</div>
                            </div>
                            <div class="history-amount positive">+300 次</div>
                        </div>
                        <div class="history-item">
                            <div class="history-icon notify">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="history-details">
                                <div class="history-action">使用通知服务</div>
                                <div class="history-time">2024/01/14 16:45</div>
                            </div>
                            <div class="history-amount usage">-3 次</div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="user-center-actions">
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        退出登录
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录注册弹窗 -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <div class="login-modal-header">
                <div class="login-modal-title">
                    <span id="loginTitle">登录</span>
                    <div class="login-modal-subtitle">登录后可自动填充邮箱，管理通知设置</div>
                </div>
                <button class="login-modal-close" onclick="closeLoginModal()">×</button>
            </div>
            <div class="login-modal-body">
                <!-- 登录表单 -->
                <div id="loginForm" class="auth-form">
                    <div class="form-group">
                        <label for="loginEmail">邮箱地址</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="请输入您的邮箱地址" oninput="validateLoginEmail()">
                        <div class="input-error" id="loginEmailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">密码</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="loginPassword" class="form-input" placeholder="请输入密码">
                            <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">
                                <i class="fas fa-eye" id="loginPasswordEye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="auth-submit-btn" onclick="submitLogin()">登录</button>
                        <div class="auth-links">
                            <a href="#" onclick="showRegisterForm()">没有账号？立即注册</a>
                            <a href="#" onclick="showForgotPassword()">忘记密码？</a>
                        </div>
                    </div>
                </div>

                <!-- 注册表单 -->
                <div id="registerForm" class="auth-form" style="display: none;">
                    <div class="form-group">
                        <label for="registerEmail">邮箱地址</label>
                        <input type="email" id="registerEmail" class="form-input" placeholder="请输入您的邮箱地址" oninput="validateRegisterEmail()">
                        <div class="input-error" id="registerEmailError"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">密码</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="registerPassword" class="form-input" placeholder="请输入密码（至少6位）" oninput="validateRegisterPassword()">
                            <button type="button" class="password-toggle" onclick="togglePassword('registerPassword')">
                                <i class="fas fa-eye" id="registerPasswordEye"></i>
                            </button>
                        </div>
                        <div class="input-error" id="registerPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">确认密码</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="confirmPassword" class="form-input" placeholder="请再次输入密码" oninput="validateConfirmPassword()">
                            <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                <i class="fas fa-eye" id="confirmPasswordEye"></i>
                            </button>
                        </div>
                        <div class="input-error" id="confirmPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="agreeTerms">
                            <span class="checkmark"></span>
                            我已阅读并同意<a href="#" onclick="showTerms()">《用户协议》</a>和<a href="#" onclick="showPrivacy()">《隐私政策》</a>
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="auth-submit-btn" onclick="submitRegister()">注册</button>
                        <div class="auth-links">
                            <a href="#" onclick="showLoginForm()">已有账号？立即登录</a>
                        </div>
                    </div>
                </div>

                <!-- 忘记密码表单 -->
                <div id="forgotPasswordForm" class="auth-form" style="display: none;">
                    <div class="form-group">
                        <label for="forgotEmail">邮箱地址</label>
                        <input type="email" id="forgotEmail" class="form-input" placeholder="请输入您的邮箱地址" oninput="validateForgotEmail()">
                        <div class="input-error" id="forgotEmailError"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="auth-submit-btn" onclick="submitForgotPassword()">发送重置邮件</button>
                        <div class="auth-links">
                            <a href="#" onclick="showLoginForm()">返回登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知订阅弹窗 -->
    <div id="notifyModal" class="notify-modal">
        <div class="notify-modal-content">
            <div class="notify-modal-header">
                <div class="notify-modal-title">
                    <span>通知我</span>
                    <div class="notify-modal-subtitle">我们该如何发送更新？</div>
                </div>
                <div class="notify-modal-actions-top">
                    <button class="notify-login-btn" onclick="showLogin()">登录/注册</button>
                    <button class="notify-modal-close" onclick="closeNotifyModal()">×</button>
                </div>
            </div>
            <div class="notify-modal-body">
                <!-- 通知类型选择 -->
                <div class="notify-section">
                    <div class="notify-section-title">选择通知类型 *</div>
                    <div class="notify-type-options">
                        <label class="notify-type-option">
                            <input type="checkbox" checked> 包裹已收件（Package Pickup）
                        </label>
                        <label class="notify-type-option">
                            <input type="checkbox"> 运输途中（In Transit）
                        </label>
                        <label class="notify-type-option">
                            <input type="checkbox"> 到达目的地（Arrived at Destination）
                        </label>
                        <label class="notify-type-option">
                            <input type="checkbox"> 清关状态（Customs Clearance）
                        </label>
                        <label class="notify-type-option">
                            <input type="checkbox"> 正在配送（Out for Delivery）
                        </label>
                        <label class="notify-type-option">
                            <input type="checkbox" checked> 投递完成（Delivered）
                        </label>
                        <label class="notify-type-option">
                            <input type="checkbox" checked> 异常或延误（Exception/Delay）
                        </label>
                    </div>
                </div>

                <!-- 通知人信息 -->
                <div class="notify-section">
                    <div class="notify-section-title">通知人信息</div>
                    <div class="notify-emails-container">
                        <div class="email-input-group" id="emailGroup1">
                            <div class="email-input-row">
                                <input type="email" id="notifyEmail1" placeholder="请输入邮箱地址" class="notify-email-input" oninput="handleEmailInput(1)">
                                <button class="email-remove-btn" onclick="removeEmail(1)" style="display: none;"></button>
                            </div>
                            <div class="email-error-message" id="emailError1"></div>
                        </div>
                    </div>
                    <button class="add-email-btn" id="addEmailBtn" onclick="addEmailInput()" style="display: none;">
                        +
                    </button>
                </div>

                <!-- 额度不足提示（仅在提交时显示） -->
                <div class="notify-quota-warning" id="quotaWarning" style="display: none;">
                    <div class="quota-warning-content">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>剩余通知次数不足，请购买更多次数后继续</span>
                        <button class="quota-recharge-btn" onclick="showRecharge()">立即购买</button>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="notify-modal-actions">
                    <button class="notify-submit-btn" onclick="submitNotify()">提交</button>
                    <button class="notify-cancel-btn" onclick="closeNotifyModal()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 获取预计到达时间
        function getEstimatedDelivery(data) {
            // 如果有明确的预计到达时间字段
            if (data.estimatedDelivery) {
                return formatDate(data.estimatedDelivery);
            }
            
            // 根据状态和事件估算到达时间
            if (data.status && data.events && data.events.length > 0) {
                const status = data.status.toLowerCase();
                const latestEvent = data.events[0];
                const latestTime = new Date(latestEvent.timestamp);
                
                // 如果已经签收，显示签收时间
                if (status.includes('delivered') || status.includes('signed') || status.includes('completed')) {
                    return formatDate(latestEvent.timestamp);
                }
                
                // 如果正在配送
                if (status.includes('out for delivery') || status.includes('delivery')) {
                    const deliveryDate = new Date(latestTime);
                    deliveryDate.setDate(deliveryDate.getDate() + 1); // 明天
                    return formatDate(deliveryDate.toISOString());
                }
                
                // 如果在运输途中，根据承运商估算
                if (status.includes('transit') || status.includes('shipped')) {
                    const carrier = data.carrier ? data.carrier.toLowerCase() : '';
                    let estimatedDays = 3; // 默认3天
                    
                    if (carrier.includes('dhl') || carrier.includes('ups') || carrier.includes('fedex')) {
                        estimatedDays = 2; // 国际快递2-3天
                    } else if (carrier.includes('ems') || carrier.includes('china post')) {
                        estimatedDays = 5; // EMS/中国邮政5-7天
                    }
                    
                    const estimatedDate = new Date(latestTime);
                    estimatedDate.setDate(estimatedDate.getDate() + estimatedDays);
                    return formatDate(estimatedDate.toISOString());
                }
            }
            
            return null;
        }

        // 获取承运商电话号码
        function getCarrierPhone(carrier) {
            const phoneMap = {
                'DHL': '+1 (800) 225-5345',
                'DHL Express': '+1 (800) 225-5345',
                'UPS': '+1 (800) 742-5877',
                'FedEx': '+1 (800) 463-3339',
                'TNT': '+1 (800) 558-5555',
                'USPS': '+1 (800) 275-8777',
                'EMS': '+86 (11185)',
                '中通': '+86 (95311)',
                '圆通': '+86 (95554)',
                '申通': '+86 (95543)',
                '韵达': '+86 (95546)',
                '顺丰': '+86 (95338)',
                'China Post': '+86 (11185)'
            };
            return phoneMap[carrier] || '+86 (400-888-8888)';
        }

        // 格式化详细时间（17track风格）
        function formatDetailTime(dateString) {
            const date = new Date(dateString);
            const timezoneOffset = '+08:00'; // 假设为GMT+8
            
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }) + ` (GMT${timezoneOffset})`;
        }

        // 获取时间轴图标类名
        function getTimelineIconClass(description) {
            const desc = description.toLowerCase();
            if (desc.includes('delivered') || desc.includes('signed')) {
                return 'delivered';
            }
            return '';
        }

        function getStatusClass(status) {
            const statusMap = {
                'Delivered': 'status-delivered',
                'In Transit': 'status-in-transit',
                'Picked Up': 'status-picked-up',
                'At Warehouse': 'status-at-warehouse',
                'Arrived': 'status-in-transit'
            };
            return statusMap[status] || 'status-in-transit';
        }

        function renderResults(results) {
            const resultsDiv = document.getElementById('results');
            
            if (!results || results.length === 0) {
                resultsDiv.innerHTML = '';
                return;
            }

            const html = results.map(data => {
                if (!data.success) {
                    return `
                        <div class="error">
                            <i class="fas fa-exclamation-triangle"></i> 
                            单号: ${data.trackingNumber || '未知'} - ${data.message}
                        </div>
                    `;
                }

                return `
                    <div class="result-card">
                        <div class="result-header">
                            <div class="carrier-info">
                                <div class="carrier-logo">
                                    ${data.carrier.substring(0, 2).toUpperCase()}
                                </div>
                                <div>
                                    <div class="carrier-name">${data.carrier}</div>
                                    <div class="tracking-number">追踪单号: ${data.trackingNumber}</div>
                                </div>
                            </div>
                            <div class="status-badge ${getStatusClass(data.status)}">
                                ${data.status}
                            </div>
                        </div>
                        
                        <div class="timeline">
                            ${data.events.map(event => `
                                <div class="timeline-item">
                                    <div class="timeline-date">
                                        ${formatDate(event.timestamp)}
                                    </div>
                                    <div class="timeline-location">
                                        ${event.location}
                                    </div>
                                    <div class="timeline-description">
                                        ${event.description}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = html;
        }

        function showLoading() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>正在查询追踪信息...</p>
                </div>
            `;
        }

        async function queryTracking(trackingNumbers) {
            try {
                const response = await fetch('/api/tracking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        trackingNumbers: trackingNumbers.filter(n => n.trim()).map(n => n.trim())
                    })
                });

                const data = await response.json();
                return data.results || [];
                
            } catch (error) {
                console.error('查询错误:', error);
                return trackingNumbers.map(trackingNumber => ({
                    success: false,
                    trackingNumber: trackingNumber.trim(),
                    message: '网络错误，请检查连接后重试'
                }));
            }
        }

        document.getElementById('trackingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const trackingNumbers = taggedInput.getValues()
                .filter(line => line.length >= 3 && line.length <= 50 && !isInvalidContent(line));
            
            if (trackingNumbers.length === 0) {
                alert('请输入有效的追踪单号');
                return;
            }

            if (trackingNumbers.length > 40) {
                alert('最多只能查询40个单号');
                return;
            }

            // 跳转到结果页面
            const params = new URLSearchParams();
            params.set('nums', trackingNumbers.join(','));
            window.location.href = `${window.location.pathname}?${params.toString()}`;
        });



        // 多标签输入框功能
        class TaggedInput {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.placeholder = this.container.querySelector('.input-placeholder');
                this.hiddenTextarea = document.getElementById('hiddenTextarea');
                this.tags = [];
                this.tempInput = null;
                this.init();
            }

            init() {
                this.container.addEventListener('click', (e) => this.handleClick(e));
                this.container.addEventListener('keydown', (e) => this.handleKeydown(e));
                this.container.addEventListener('paste', (e) => this.handlePaste(e));
                document.addEventListener('click', (e) => this.handleDocumentClick(e));
            }

            handleClick(e) {
                if (e.target.classList.contains('tag-remove')) {
                    this.removeTag(e.target.dataset.index);
                    return;
                }
                this.focusInput();
            }

            handleKeydown(e) {
                // 处理删除键选中内容的删除
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const selectedText = selection.toString();
                        
                        // 如果选中了内容，查找并删除对应的标签
                        if (selectedText.trim()) {
                            const tagsToRemove = [];
                            this.tags.forEach((tag, index) => {
                                if (selectedText.includes(tag)) {
                                    tagsToRemove.push(index);
                                }
                            });
                            
                            // 从后往前删除，避免索引变化
                            tagsToRemove.reverse().forEach(index => {
                                this.removeTag(index);
                            });
                            
                            if (tagsToRemove.length > 0) {
                                e.preventDefault();
                                return;
                            }
                        }
                    }
                }
                
                if (!this.tempInput) return;
                
                if (e.key === 'Enter' || e.key === ',' || e.key === ' ') {
                    e.preventDefault();
                    this.processInput();
                } else if (e.key === 'Backspace' && this.tempInput.value === '' && this.tags.length > 0) {
                    this.removeTag(this.tags.length - 1);
                }
            }

            handlePaste(e) {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                this.processText(text);
            }

            handleDocumentClick(e) {
                if (!this.container.contains(e.target)) {
                    this.processInput();
                    this.removeTempInput();
                }
            }

            focusInput() {
                if (!this.tempInput) {
                    this.tempInput = document.createElement('input');
                    this.tempInput.className = 'temp-input';
                    this.tempInput.addEventListener('input', () => this.handleInput());
                    this.container.appendChild(this.tempInput);
                }
                this.tempInput.focus();
                this.updatePlaceholder();
            }

            handleInput() {
                const value = this.tempInput.value;
                if (value.includes(',') || value.includes('\n') || value.includes(' ')) {
                    this.processInput();
                }
            }

            processInput() {
                if (!this.tempInput || !this.tempInput.value.trim()) return;
                this.processText(this.tempInput.value);
                this.tempInput.value = '';
            }

            processText(text) {
                const numbers = text
                    .split(/[,\n\s，、；;]+/)
                    .map(n => n.trim())
                    .filter(n => n && n.length > 0);
                
                numbers.forEach(number => this.addTag(number));
                this.updateDisplay();
            }

            addTag(text) {
                if (this.tags.includes(text) || this.tags.length >= 40) return;
                
                this.tags.push(text);
                this.renderTags();
                this.updateDisplay();
            }

            removeTag(index) {
                this.tags.splice(index, 1);
                this.renderTags();
                this.updateDisplay();
            }

            renderTags() {
                // 清除现有标签
                this.container.querySelectorAll('.tracking-tag').forEach(tag => tag.remove());
                
                // 渲染新标签
                this.tags.forEach((tag, index) => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tracking-tag';
                    tagElement.innerHTML = `
                        <span class="tag-number">${index + 1}.</span>
                        <span class="tag-content" data-tracking-number="${tag}">${tag}</span>
                        <button class="tag-remove" data-index="${index}">×</button>
                    `;
                    
                    // 添加双击复制功能
                    const contentElement = tagElement.querySelector('.tag-content');
                    contentElement.addEventListener('dblclick', () => {
                        this.copyToClipboard(tag);
                    });
                    
                    this.container.insertBefore(tagElement, this.tempInput || this.placeholder);
                });
            }

            copyToClipboard(text) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showCopySuccess();
                    });
                } else {
                    // 兼容旧浏览器
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showCopySuccess();
                }
            }

            showCopySuccess() {
                // 简单的复制成功提示
                const tooltip = document.createElement('div');
                tooltip.textContent = '已复制到剪贴板';
                tooltip.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    font-size: 14px;
                    z-index: 10000;
                    animation: fadeInOut 2s ease-in-out;
                `;
                document.body.appendChild(tooltip);
                
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 2000);
            }

            showFilterSuccess(originalCount, filteredCount) {
                // 筛选成功提示
                const tooltip = document.createElement('div');
                tooltip.textContent = `筛选完成：${originalCount} → ${filteredCount} 个单号`;
                tooltip.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #2196F3;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    font-size: 14px;
                    z-index: 10000;
                    animation: fadeInOut 2s ease-in-out;
                `;
                document.body.appendChild(tooltip);
                
                setTimeout(() => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                }, 2000);
            }

            removeTempInput() {
                if (this.tempInput) {
                    this.tempInput.remove();
                    this.tempInput = null;
                }
            }

            updatePlaceholder() {
                if (this.tags.length > 0 || (this.tempInput && this.tempInput.value)) {
                    this.placeholder.classList.add('hidden');
                } else {
                    this.placeholder.classList.remove('hidden');
                }
            }

            updateDisplay() {
                this.updatePlaceholder();
                this.updateHiddenTextarea();
                this.updateActions();
                this.updateTrackingCount();
            }

            updateHiddenTextarea() {
                this.hiddenTextarea.value = this.tags.join('\n');
            }

            updateActions() {
                const inputActions = document.querySelector('.input-actions');
                if (this.tags.length > 0) {
                    inputActions.classList.add('show');
                } else {
                    inputActions.classList.remove('show');
                }
            }

            updateTrackingCount() {
                const countElement = document.getElementById('trackingCount');
                if (this.tags.length > 0) {
                    countElement.setAttribute('data-count', this.tags.length);
                    countElement.classList.add('show');
                } else {
                    countElement.classList.remove('show');
                }
            }

            clear() {
                this.tags = [];
                this.renderTags();
                this.updateDisplay();
                this.removeTempInput();
            }

            getValues() {
                this.processInput(); // 处理可能未完成的输入
                return this.tags;
            }

            setValues(values) {
                this.tags = values.filter(v => v && v.trim());
                this.renderTags();
                this.updateDisplay();
            }
        }

        // 初始化标签输入框
        const taggedInput = new TaggedInput('trackingNumbers');

        // 判断是否为无效内容
        function isInvalidContent(content) {
            // 去掉首尾空格
            content = content.trim();
            
            // 只包含横杠、点号、空格等符号的内容
            if (/^[-.\s_=+*#@!~`()[\]{}|\\/<>?:;'"]*$/.test(content)) {
                return true;
            }
            
            // 只包含数字编号（如：1. 2. 3.），但不包括长数字单号
            if (/^\d{1,3}\.?\s*$/.test(content)) {
                return true;
            }
            
            // 只包含重复字符（如：---、...、===）
            if (/^(.)\1{2,}$/.test(content)) {
                return true;
            }
            
            // 常见的无效词汇
            const invalidWords = [
                '---', '...', '===', '___', '+++', '***', '###',
                'null', 'undefined', 'none', 'empty', 'test', 'demo',
                '无', '空', '测试', '示例', '样例', '例子'
            ];
            
            if (invalidWords.includes(content.toLowerCase())) {
                return true;
            }
            
            // 只包含中文说明文字（没有字母和数字）
            if (/^[\u4e00-\u9fa5\s\p{P}]+$/u.test(content) && !/[a-zA-Z0-9]/.test(content)) {
                return true;
            }
            
            return false;
        }

        // 筛选单号功能
        document.getElementById('filterButton').addEventListener('click', function() {
            const currentTags = taggedInput.getValues();
            
            if (currentTags.length === 0) {
                return;
            }

            // 筛选处理
            const filteredLines = [];
            const seenNumbers = new Set();

            for (let line of currentTags) {
                const cleanLine = line.trim();
                
                // 跳过空行
                if (!cleanLine) continue;
                
                // 跳过太短的单号（少于3个字符）
                if (cleanLine.length < 3) continue;
                
                // 跳过太长的单号（超过50个字符）
                if (cleanLine.length > 50) continue;
                
                // 跳过明显无效的内容
                if (isInvalidContent(cleanLine)) continue;
                
                // 去重
                if (seenNumbers.has(cleanLine)) continue;
                
                seenNumbers.add(cleanLine);
                filteredLines.push(cleanLine);
            }

            // 限制40个单号
            if (filteredLines.length > 40) {
                filteredLines.splice(40);
            }

            // 更新标签输入系统
            taggedInput.setValues(filteredLines);
        });

        // 删除所有功能
        document.getElementById('clearButton').addEventListener('click', function() {
            // 清空标签
            taggedInput.clear();
            
            // 清空查询结果
            document.getElementById('results').innerHTML = '';
            
            // 聚焦输入框
            taggedInput.focusInput();
        });

        // 页面加载时检查URL参数
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const nums = urlParams.get('nums');
            
            if (nums) {
                // 显示结果页面
                showResultsPage(nums);
            } else {
                // 初始化搜索页面
                initSearchPage();
            }
        });

        // 初始化搜索页面
        function initSearchPage() {
            // 标签输入系统会自动处理显示更新
        }

        // 显示结果页面
        async function showResultsPage(nums) {
            // 隐藏搜索界面
            document.querySelector('.container').style.display = 'none';
            
            // 创建结果页面容器
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'results-page';
            resultsContainer.innerHTML = `
                <div class="results-header">
                    <div class="header-content">
                        <h2>查询结果</h2>
                        <button onclick="window.location.href='${window.location.pathname}'" class="back-btn">
                            <i class="fas fa-arrow-left"></i> 返回
                        </button>
                    </div>
                </div>
                <div class="status-summary">
                    <div class="summary-content" id="statusSummary">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>正在统计结果...</p>
                        </div>
                    </div>
                </div>
                <div class="results-content">
                    <div id="resultsContent" class="results-table">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>正在查询追踪信息...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(resultsContainer);
            
            // 解析单号并查询
            const trackingNumbers = nums.split(',').map(n => n.trim()).filter(n => n);
            
            try {
                const results = await queryTracking(trackingNumbers);
                renderResultsPage(results);
            } catch (error) {
                console.error('查询错误:', error);
                document.getElementById('resultsContent').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i> 查询失败，请稍后重试
                    </div>
                `;
            }
        }

        // 获取承运商图标类名
        function getCarrierIconClass(carrier) {
            if (carrier.toLowerCase().includes('dhl')) return 'dhl';
            if (carrier.toLowerCase().includes('ups')) return 'ups';
            if (carrier.toLowerCase().includes('fedex')) return 'fedex';
            return 'unknown';
        }

        // 获取承运商显示名称
        function getCarrierDisplayName(carrier) {
            const iconClass = getCarrierIconClass(carrier);
            return iconClass.toUpperCase();
        }

        // 解析地址信息
        function parseLocationInfo(events) {
            if (!events || events.length === 0) return { from: '未知', to: '未知' };
            
            const firstEvent = events[events.length - 1]; // 最早的事件
            const lastEvent = events[0]; // 最新的事件
            
            // 简化地址显示
            const from = firstEvent.location.split(',')[0] || firstEvent.location;
            const to = lastEvent.location.split(',')[0] || lastEvent.location;
            
            return { from, to };
        }

        // 渲染结果页面
        function renderResultsPage(results) {
            const resultsContent = document.getElementById('resultsContent');
            const statusSummary = document.getElementById('statusSummary');
            
            if (!results || results.length === 0) {
                resultsContent.innerHTML = '<div class="no-results">没有找到查询结果</div>';
                statusSummary.innerHTML = `
                    <div class="status-tab tab-total">
                        <span class="icon"><i class="fas fa-clipboard-list"></i></span>
                        <span class="count">0</span>
                                            <div class="tooltip">
                        <div class="tooltip-title">全部 (Total)</div>
                        <div class="tooltip-desc">包裹状态是指当前包裹的运输状态。<br><br>系统中分为以下几种：信息录入、收件提取、运输途中、清关状态、异常状态、末端配送、签收完成、时效分析。在查询之后，系统会根据货物状态描述显示对应的状态。<br><br>包裹状态是系统根据详细查询信息进行自动判断，仅供参考。<br><br>如果判断错误，请通知13424243144进行修正，以完善系统。</div>
                    </div>
                    </div>
                    <div class="status-tab tab-info">
                        <span class="icon"><i class="fas fa-file-alt"></i></span>
                        <span class="count">0</span>
                        <div class="tooltip">
                            <div class="tooltip-title">信息录入 (Information Entry)</div>
                            <div class="tooltip-desc">包裹信息状态阶段，包括单号查询结果、信息接收状态、电子信息创建和运单生成，但包裹尚未正式进入物理运输网络。</div>
                            <div class="tooltip-states">
                                <div class="state-item">查询不到 (Not Found)</div>
                                <div class="state-item">信息已接收 (Info Received)</div>
                                <div class="state-item">电子信息 (Electronic Info)</div>
                                <div class="state-item">标签创建 (Label Created)</div>
                                <div class="state-item">运单已生成 (Waybill Generated)</div>
                                <div class="state-item">等待取件 (Awaiting Pickup)</div>
                            </div>
                        </div>
                    </div>
                    <div class="status-tab tab-pickup">
                        <span class="icon"><i class="fas fa-box"></i></span>
                        <span class="count">0</span>
                        <div class="tooltip">
                            <div class="tooltip-title">收件提取</div>
                            <div class="tooltip-desc">包裹已收取，正式进入承运商运输网络，完成首次扫描和数据录入。</div>
                            <div class="tooltip-states">
                                <div class="state-item">已收件 (Collected)</div>
                                <div class="state-item">承运商已取件 (Picked Up)</div>
                                <div class="state-item">到达扫描 (Arrival Scan)</div>
                                <div class="state-item">分拣中心接收 (Hub Received)</div>
                            </div>
                        </div>
                    </div>
                    <div class="status-tab tab-transit">
                        <span class="icon"><i class="fas fa-plane"></i></span>
                        <span class="count">0</span>
                        <div class="tooltip">
                            <div class="tooltip-title">运输途中 (In Transit)</div>
                            <div class="tooltip-desc">包裹在承运商运输网络中移动，包括分拣、装运、转运等各个环节。</div>
                            <div class="tooltip-states">
                                <div class="state-item">运输中 (In Transit)</div>
                                <div class="state-item">国内运输 (Domestic Transit)</div>
                                <div class="state-item">国际运输 (International Transit)</div>
                                <div class="state-item">中转途中 (In Transfer)</div>
                                <div class="state-item">到达目的地 (Arrived at Destination)</div>
                            </div>
                        </div>
                    </div>
                    <div class="status-tab tab-customs">
                        <span class="icon"><i class="fas fa-passport"></i></span>
                        <span class="count">0</span>
                        <div class="tooltip">
                            <div class="tooltip-title">清关状态 (Customs Clearance)</div>
                            <div class="tooltip-desc">跨境包裹必经环节，涉及海关检查、税费缴纳等流程。</div>
                            <div class="tooltip-states">
                                <div class="state-item">清关状态 (Customs Clearance)</div>
                                <div class="state-item">清关中 (In Customs)</div>
                                <div class="state-item">清关完成 (Customs Cleared)</div>
                                <div class="state-item">清关放行 (Released from Customs)</div>
                            </div>
                        </div>
                    </div>
                                    <div class="status-tab tab-exception">
                    <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <span class="count">0</span>
                    <div class="tooltip">
                        <div class="tooltip-title">异常状态 (Exception Status)</div>
                        <div class="tooltip-desc">运输过程中出现异常情况，需要特别关注的状态。</div>
                        <div class="tooltip-states">
                            <div class="exception-category">
                                <div class="category-title">⚠️ 运输异常 (Transit Exception)</div>
                                <div class="category-items">
                                    <div class="state-item">清关延误 (Customs Delay)</div>
                                    <div class="state-item">地址错误 (Address Error)</div>
                                    <div class="state-item">包裹损坏 (Package Damaged)</div>
                                    <div class="state-item">天气延误 (Weather Delay)</div>
                                    <div class="state-item">运力不足 (Capacity Constraint)</div>
                                </div>
                            </div>
                            <div class="exception-category">
                                <div class="category-title">❌ 投递失败 (Delivery Failed)</div>
                                <div class="category-items">
                                    <div class="state-item">收件人不在 (Recipient Unavailable)</div>
                                    <div class="state-item">拒收退回 (Refused/Returned)</div>
                                    <div class="state-item">多次投递失败 (Multiple Delivery Attempts Failed)</div>
                                    <div class="state-item">无人签收 (No One Available to Sign)</div>
                                    <div class="state-item">收件人拒收 (Refused by Recipient)</div>
                                </div>
                            </div>
                            <div class="exception-category">
                                <div class="category-title">🔍 状态未知 (Status Unknown)</div>
                                <div class="category-items">
                                    <div class="state-item">查询不到 (No Information Available)</div>
                                    <div class="state-item">系统延迟 (System Delay)</div>
                                    <div class="state-item">可能遗失 (Possibly Lost)</div>
                                    <div class="state-item">运输过久 (Long Transit Time)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <div class="status-tab tab-delivery">
                        <span class="icon"><i class="fas fa-truck"></i></span>
                        <span class="count">0</span>
                        <div class="tooltip">
                            <div class="tooltip-title">末端配送 (Final Delivery)</div>
                            <div class="tooltip-desc">最后一公里配送，快递员正在进行最终配送。</div>
                            <div class="tooltip-states">
                                <div class="state-item">派送中 (Out for Delivery)</div>
                                <div class="state-item">到达派送站 (At Delivery Facility)</div>
                                <div class="state-item">到达代收点 (At Pickup Point)</div>
                                <div class="state-item">等待自提 (Ready for Pickup)</div>
                            </div>
                        </div>
                    </div>
                    <div class="status-tab tab-delivered">
                        <span class="icon"><i class="fas fa-check-circle"></i></span>
                        <span class="count">0</span>
                        <div class="tooltip">
                            <div class="tooltip-title">签收完成 (Delivered)</div>
                            <div class="tooltip-desc">包裹已成功送达，物流服务流程正常完成。</div>
                            <div class="tooltip-states">
                                <div class="state-item">投递完成 (Successfully Delivered)</div>
                                <div class="state-item">成功签收 (Signed by Recipient)</div>
                                <div class="state-item">代收签收 (Delivered to Agent)</div>
                                <div class="state-item">快递柜签收 (Delivered to Locker)</div>
                                <div class="state-item">自提完成 (Picked Up by Recipient)</div>
                            </div>
                        </div>
                    </div>
                    <div class="status-tab tab-time-analysis">
                        <span class="icon"><i class="fas fa-chart-line"></i></span>
                        <span class="count">0</span>
                        <div class="tooltip">
                            <div class="tooltip-title">时效分析 (Time Analysis)</div>
                            <div class="tooltip-desc">基于承运商承诺时效和路线特点进行智能分析。</div>
                            <div class="tooltip-states">
                                <div class="state-item">时效分析 (Time Analysis)</div>
                                <div class="state-item">正常时效 (On Time)</div>
                                <div class="state-item">轻微延误 (Slightly Delayed) - 超时1-2天</div>
                                <div class="state-item">明显延误 (Significantly Delayed) - 超时3-7天</div>
                                <div class="state-item">严重延误 (Severely Delayed) - 超时7-14天</div>
                                <div class="state-item">疑似丢失 (Possibly Lost) - 超时14天以上</div>
                            </div>
                        </div>
                    </div>
                `;
                

                
                // 重新初始化横线效果
                setTimeout(() => {
                    addStatusBarHoverEffect();
                }, 100);
                return;
            }

            // 智能状态分类函数
            function getStatusCategory(status) {
                if (!status) return 'unknown';
                
                const statusLower = status.toLowerCase();
                
                // 信息录入状态
                if (statusLower.includes('not found') || statusLower.includes('info received') || 
                    statusLower.includes('electronic info') || statusLower.includes('label created') ||
                    statusLower.includes('waybill generated') || statusLower.includes('awaiting pickup')) {
                    return 'info';
                }
                
                // 收件提取状态
                if (statusLower.includes('picked up') || statusLower.includes('processing') || 
                    statusLower.includes('collected') || statusLower.includes('arrival scan') ||
                    statusLower.includes('hub received')) {
                    return 'pickup';
                }
                
                // 运输途中状态
                if (statusLower.includes('in transit') || statusLower.includes('transit') || 
                    statusLower.includes('shipped') || statusLower.includes('domestic transit') ||
                    statusLower.includes('international transit') || statusLower.includes('in transfer') ||
                    statusLower.includes('arrived at destination')) {
                    return 'transit';
                }
                
                // 清关状态
                if (statusLower.includes('customs') || statusLower.includes('clearance') ||
                    statusLower.includes('in customs') || statusLower.includes('customs cleared') ||
                    statusLower.includes('released from customs')) {
                    return 'customs';
                }
                
                // 异常状态
                if (statusLower.includes('exception') || statusLower.includes('delayed') || 
                    statusLower.includes('failed') || statusLower.includes('error') ||
                    statusLower.includes('damage') || statusLower.includes('refused') ||
                    statusLower.includes('unavailable') || statusLower.includes('lost')) {
                    return 'exception';
                }
                
                // 末端配送状态
                if (statusLower.includes('out for delivery') || statusLower.includes('final delivery') ||
                    statusLower.includes('delivery') || statusLower.includes('at delivery facility') ||
                    statusLower.includes('at pickup point') || statusLower.includes('ready for pickup')) {
                    return 'delivery';
                }
                
                // 签收完成状态
                if (statusLower.includes('delivered') || statusLower.includes('completed') || 
                    statusLower.includes('signed') || statusLower.includes('successfully delivered') ||
                    statusLower.includes('picked up by recipient')) {
                    return 'delivered';
                }
                
                return 'unknown';
            }
            
            // 统计结果
            const total = results.length;
            const infoCount = results.filter(r => r.success && getStatusCategory(r.status) === 'info').length;
            const pickedUpCount = results.filter(r => r.success && getStatusCategory(r.status) === 'pickup').length;
            const inTransitCount = results.filter(r => r.success && getStatusCategory(r.status) === 'transit').length;
            const customsCount = results.filter(r => r.success && getStatusCategory(r.status) === 'customs').length;
            const exceptionCount = results.filter(r => r.success && getStatusCategory(r.status) === 'exception').length;
            const deliveryCount = results.filter(r => r.success && getStatusCategory(r.status) === 'delivery').length;
            const deliveredCount = results.filter(r => r.success && getStatusCategory(r.status) === 'delivered').length;
            const errorCount = results.filter(r => !r.success).length;
            const totalExceptionCount = exceptionCount + errorCount;

            // 渲染17track风格的状态栏（按8个点重新设计）
            statusSummary.innerHTML = `
                <div class="status-tab tab-total">
                    <span class="icon"><i class="fas fa-clipboard-list"></i></span>
                    <span class="count">${total}</span>
                    <div class="tooltip">
                        <div class="tooltip-title">全部 (Total)</div>
                        <div class="tooltip-desc">包裹状态是指当前包裹的运输状态。<br><br>系统中分为以下几种：信息录入、收件提取、运输途中、清关状态、异常状态、末端配送、签收完成、时效分析。在查询之后，系统会根据货物状态描述显示对应的状态。<br><br>包裹状态是系统根据详细查询信息进行自动判断，仅供参考。<br><br>如果判断错误，请通知13424243144进行修正，以完善系统。</div>
                    </div>
                </div>
                <div class="status-tab tab-info">
                    <span class="icon"><i class="fas fa-file-alt"></i></span>
                    <span class="count">${infoCount}</span>
                    <div class="tooltip">
                        <div class="tooltip-title">信息录入 (Information Entry)</div>
                        <div class="tooltip-desc">包裹信息状态阶段，包括单号查询结果、信息接收状态、电子信息创建和运单生成，但包裹尚未正式进入物理运输网络。</div>
                        <div class="tooltip-states">
                            <div class="state-item">查询不到 (Not Found)</div>
                            <div class="state-item">信息已接收 (Info Received)</div>
                            <div class="state-item">电子信息 (Electronic Info)</div>
                            <div class="state-item">标签创建 (Label Created)</div>
                            <div class="state-item">运单已生成 (Waybill Generated)</div>
                            <div class="state-item">等待取件 (Awaiting Pickup)</div>
                        </div>
                    </div>
                </div>
                <div class="status-tab tab-pickup">
                    <span class="icon"><i class="fas fa-box"></i></span>
                    <span class="count">${pickedUpCount}</span>
                    <div class="tooltip">
                        <div class="tooltip-title">收件提取 (Collection Processing)</div>
                        <div class="tooltip-desc">包裹已收取，正式进入承运商运输网络，完成首次扫描和数据录入。</div>
                        <div class="tooltip-states">
                            <div class="state-item">已收件 (Collected)</div>
                            <div class="state-item">承运商已取件 (Picked Up)</div>
                            <div class="state-item">到达扫描 (Arrival Scan)</div>
                            <div class="state-item">分拣中心接收 (Hub Received)</div>
                        </div>
                    </div>
                </div>
                <div class="status-tab tab-transit">
                    <span class="icon"><i class="fas fa-plane"></i></span>
                    <span class="count">${inTransitCount}</span>
                    <div class="tooltip">
                        <div class="tooltip-title">运输途中 (In Transit)</div>
                        <div class="tooltip-desc">包裹在承运商运输网络中移动，包括分拣、装运、转运等各个环节。</div>
                        <div class="tooltip-states">
                            <div class="state-item">运输中 (In Transit)</div>
                            <div class="state-item">国内运输 (Domestic Transit)</div>
                            <div class="state-item">国际运输 (International Transit)</div>
                            <div class="state-item">中转途中 (In Transfer)</div>
                            <div class="state-item">到达目的地 (Arrived at Destination)</div>
                        </div>
                    </div>
                </div>
                <div class="status-tab tab-customs">
                    <span class="icon"><i class="fas fa-passport"></i></span>
                    <span class="count">${customsCount}</span>
                    <div class="tooltip">
                        <div class="tooltip-title">清关状态 (Customs Clearance)</div>
                        <div class="tooltip-desc">跨境包裹必经环节，涉及海关检查、税费缴纳等流程。</div>
                        <div class="tooltip-states">
                            <div class="state-item">清关状态 (Customs Clearance)</div>
                            <div class="state-item">清关中 (In Customs)</div>
                            <div class="state-item">清关完成 (Customs Cleared)</div>
                            <div class="state-item">清关放行 (Released from Customs)</div>
                        </div>
                    </div>
                </div>
                <div class="status-tab tab-exception">
                    <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <span class="count">${totalExceptionCount}</span>
                    <div class="tooltip">
                        <div class="tooltip-title">异常状态 (Exception Status)</div>
                        <div class="tooltip-desc">运输过程中出现异常情况，需要特别关注的状态。</div>
                        <div class="tooltip-states">
                            <div class="exception-category">
                                <div class="category-title">⚠️ 运输异常 (Transit Exception)</div>
                                <div class="category-items">
                                    <div class="state-item">清关延误 (Customs Delay)</div>
                                    <div class="state-item">地址错误 (Address Error)</div>
                                    <div class="state-item">包裹损坏 (Package Damaged)</div>
                                    <div class="state-item">天气延误 (Weather Delay)</div>
                                    <div class="state-item">运力不足 (Capacity Constraint)</div>
                                </div>
                            </div>
                            <div class="exception-category">
                                <div class="category-title">❌ 投递失败 (Delivery Failed)</div>
                                <div class="category-items">
                                    <div class="state-item">收件人不在 (Recipient Unavailable)</div>
                                    <div class="state-item">拒收退回 (Refused/Returned)</div>
                                    <div class="state-item">多次投递失败 (Multiple Delivery Attempts Failed)</div>
                                    <div class="state-item">无人签收 (No One Available to Sign)</div>
                                    <div class="state-item">收件人拒收 (Refused by Recipient)</div>
                                </div>
                            </div>
                            <div class="exception-category">
                                <div class="category-title">🔍 状态未知 (Status Unknown)</div>
                                <div class="category-items">
                                    <div class="state-item">查询不到 (No Information Available)</div>
                                    <div class="state-item">系统延迟 (System Delay)</div>
                                    <div class="state-item">可能遗失 (Possibly Lost)</div>
                                    <div class="state-item">运输过久 (Long Transit Time)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="status-tab tab-delivery">
                    <span class="icon"><i class="fas fa-truck"></i></span>
                    <span class="count">${deliveryCount}</span>
                    <div class="tooltip">
                        <div class="tooltip-title">末端配送 (Final Delivery)</div>
                        <div class="tooltip-desc">最后一公里配送，快递员正在进行最终配送。</div>
                        <div class="tooltip-states">
                            <div class="state-item">派送中 (Out for Delivery)</div>
                            <div class="state-item">到达派送站 (At Delivery Facility)</div>
                            <div class="state-item">到达代收点 (At Pickup Point)</div>
                            <div class="state-item">等待自提 (Ready for Pickup)</div>
                        </div>
                    </div>
                </div>
                <div class="status-tab tab-delivered">
                    <span class="icon"><i class="fas fa-check-circle"></i></span>
                    <span class="count">${deliveredCount}</span>
                    <div class="tooltip">
                        <div class="tooltip-title">签收完成 (Delivered)</div>
                        <div class="tooltip-desc">包裹已成功送达，物流服务流程正常完成。</div>
                        <div class="tooltip-states">
                            <div class="state-item">投递完成 (Successfully Delivered)</div>
                            <div class="state-item">成功签收 (Signed by Recipient)</div>
                            <div class="state-item">代收签收 (Delivered to Agent)</div>
                            <div class="state-item">快递柜签收 (Delivered to Locker)</div>
                            <div class="state-item">自提完成 (Picked Up by Recipient)</div>
                        </div>
                    </div>
                </div>
                <div class="status-tab tab-time-analysis">
                    <span class="icon"><i class="fas fa-chart-line"></i></span>
                    <span class="count">0</span>
                    <div class="tooltip">
                        <div class="tooltip-title">时效分析 (Time Analysis)</div>
                        <div class="tooltip-desc">基于承运商承诺时效和路线特点进行智能分析。</div>
                        <div class="tooltip-states">
                            <div class="state-item">时效分析 (Time Analysis)</div>
                            <div class="state-item">正常时效 (On Time)</div>
                            <div class="state-item">轻微延误 (Slightly Delayed) - 超时1-2天</div>
                            <div class="state-item">明显延误 (Significantly Delayed) - 超时3-7天</div>
                            <div class="state-item">严重延误 (Severely Delayed) - 超时7-14天</div>
                            <div class="state-item">疑似丢失 (Possibly Lost) - 超时14天以上</div>
                        </div>
                    </div>
                </div>
            `;


            // 渲染结果列表（不再过滤In Transit，全部显示）
            const html = results.map((data, index) => {
                if (!data.success) {
                    return `
                        <div class="result-item error-item" onclick="toggleDetails(${index})">
                            <div class="result-left">
                                <div class="status-section">
                                    <div class="status-icon-pure" style="color: #ef4444">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div class="status-text-info">
                                        <div class="status-text-line">
                                            <div class="status-text">查询不到</div>
                                            <div class="status-time">--</div>
                                        </div>
                                        <div class="tracking-section">
                                            <div class="tracking-number">${data.trackingNumber || '未知'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="result-middle">
                                <div class="carrier-info">
                                    <div class="carrier-name error" onclick="event.stopPropagation(); openCarrierModal('${data.trackingNumber}')">选择服务商</div>
                                </div>
                                <div class="location-info">
                                    <span class="error-message">
                                        ${data.message || '无法识别该单号格式，请检查单号是否正确'}
                                    </span>
                                    <div class="notify-btn" title="订阅通知" onclick="openNotifyModal('${data.trackingNumber}')">
                                        <i class="fas fa-bell"></i>
                                    </div>
                                    <div class="delivery-info">
                                        <!-- 错误状态下不显示预计到达时间和轨迹 -->
                                    </div>
                                </div>
                            </div>
                            <div class="result-right">
                                <div class="status-info">
                                    <div class="last-update">请确认单号是否正确</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const locationInfo = parseLocationInfo(data.events);
                const latestEvent = data.events && data.events[0];
                const carrierIcon = getCarrierIconClass(data.carrier);
                const carrierDisplayName = getCarrierDisplayName(data.carrier);
                const statusIconInfo = getStatusIconInfo(data.status);

                return `
                    <div class="result-item" onclick="toggleDetails(${index})">
                        <div class="result-left">
                            <div class="status-section">
                                <div class="status-icon-pure" style="color: ${statusIconInfo.color}">
                                    <i class="${statusIconInfo.icon}"></i>
                                </div>
                                <div class="status-text-info">
                                    <div class="status-text-line">
                                        <div class="status-text">${data.status}</div>
                                        <div class="status-time">1天</div>
                                    </div>
                                    <div class="tracking-section">
                                        <div class="tracking-number">${data.trackingNumber}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="result-middle">
                            <div class="carrier-info" onmouseleave="hideCarrierMenu(this)">
                                <div class="carrier-name" onmouseenter="showCarrierMenu(this, '${data.carrier}')">${carrierDisplayName}</div>
                                <div class="carrier-menu">
                                    <a href="${getCarrierTrackingUrl(data.carrier, data.trackingNumber)}" target="_blank" class="carrier-menu-item" onclick="event.stopPropagation()">
                                        <i class="fas fa-home"></i>
                                        官网追踪
                                    </a>
                                    <a href="#" class="carrier-menu-item" onclick="event.stopPropagation(); openCarrierModal()">
                                        <i class="fas fa-truck"></i>
                                        选择服务商
                                    </a>
                                </div>
                            </div>
                            <div class="location-info">
                                <span class="location-from">${locationInfo.from}</span>
                                <span class="location-arrow">→</span>
                                <span class="location-to">${locationInfo.to}</span>
                                <div class="notify-btn" title="订阅通知" onclick="openNotifyModal('${data.trackingNumber}')">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="delivery-info">
                                    ${getEstimatedDelivery(data) ? `
                                        <div class="estimated-delivery" title="预计到达时间">
                                            <span class="delivery-label">预计到达时间:</span>
                                            <span class="delivery-date">${getEstimatedDelivery(data)}</span>
                                        </div>
                                    ` : ''}
                                    ${latestEvent ? `
                                        <div class="latest-event" title="${latestEvent.description}">
                                            <span class="event-description">${latestEvent.description}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="result-right">
                            <div class="toggle-details-btn" onclick="toggleDetails(${index}); event.stopPropagation();" id="toggle-btn-${index}" title="展开详细信息">
                                <span class="toggle-symbol">▼</span>
                            </div>
                        </div>
                    </div>
                    <div id="details-${index}" class="result-details">
                        ${data.events ? `
                            <div class="tracking-details">
                                <div class="tracking-details-header">
                                    <div class="carrier-icon-large ${getCarrierIconClass(data.carrier)}">
                                        ${getCarrierDisplayName(data.carrier)}
                                    </div>
                                    <div class="tracking-details-title">
                                        <div class="tracking-details-carrier">${data.carrier} - 中国 - 电话: ${getCarrierPhone(data.carrier)} - 同步时间: ${formatDetailTime(new Date())}</div>
                                    </div>
                                </div>
                                <div class="tracking-timeline-container">
                                    ${data.events.map((event, eventIndex) => `
                                        <div class="tracking-timeline-item ${eventIndex === 0 ? 'latest' : ''}">
                                            <div class="timeline-datetime">${formatDetailTime(event.timestamp)}</div>
                                            <div class="timeline-location">${event.location || ''}</div>
                                            <div class="timeline-description">${event.description}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join(''); // 移除空字符串项
            
            resultsContent.innerHTML = html;
            
            // 重新初始化横线效果
            setTimeout(() => {
                addStatusBarHoverEffect();
            }, 100);
        }

        // 获取承运商官网追踪链接（带单号）
        function getCarrierTrackingUrl(carrier, trackingNumber) {
            const trackingUrlMap = {
                'DHL': `https://mydhl.express.dhl/gb/en/tracking.html#/results?id=${encodeURIComponent(trackingNumber)}`,
                'DHL Express': `https://mydhl.express.dhl/gb/en/tracking.html#/results?id=${encodeURIComponent(trackingNumber)}`,
                'UPS': `https://www.ups.com/track?loc=en_US&tracknum=${encodeURIComponent(trackingNumber)}`,
                'FedEx': `https://www.fedex.com/fedextrack/?trknbr=${encodeURIComponent(trackingNumber)}`,
                'TNT': `https://www.tnt.com/express/en_us/site_tools/tracking.html?searchType=con&cons=${encodeURIComponent(trackingNumber)}`,
                'USPS': `https://tools.usps.com/go/TrackConfirmAction?tLabels=${encodeURIComponent(trackingNumber)}`,
                'EMS': `https://www.ems.com.cn/qps/ems/bill/${encodeURIComponent(trackingNumber)}`,
                '中通': `https://www.zto.com/GuestService/Bill?txtWaybillNo=${encodeURIComponent(trackingNumber)}`,
                '圆通': `https://www.yto.net.cn/query/${encodeURIComponent(trackingNumber)}`,
                '申通': `https://www.sto.cn/query.html?billcode=${encodeURIComponent(trackingNumber)}`,
                '韵达': `https://www.yunda.com/query/${encodeURIComponent(trackingNumber)}`,
                '顺丰': `https://www.sf-express.com/cn/sc/dynamic_function/waybill/#search/bill-number/${encodeURIComponent(trackingNumber)}`,
                '京东': `https://www.jd.com/track.aspx?orderid=${encodeURIComponent(trackingNumber)}`,
                'China Post': `https://www.chinapost.com.cn/query/detail?mailno=${encodeURIComponent(trackingNumber)}`
            };
            
            return trackingUrlMap[carrier] || `https://www.google.com/search?q=${encodeURIComponent(carrier + ' tracking ' + trackingNumber)}`;
        }

        // 获取状态图标信息 - 直接使用与上面状态栏完全相同的图标
        function getStatusIconInfo(status) {
            const statusMap = {
                // 信息录入状态 - 对应上面的文档图标
                'Not Found': { icon: 'fas fa-file-alt', color: '#3b82f6' },
                'Info Received': { icon: 'fas fa-file-alt', color: '#3b82f6' },
                'Electronic Info': { icon: 'fas fa-file-alt', color: '#3b82f6' },
                'Label Created': { icon: 'fas fa-file-alt', color: '#3b82f6' },
                
                // 收件提取状态 - 对应上面的盒子图标
                'Picked Up': { icon: 'fas fa-box', color: '#10b981' },
                'Processing': { icon: 'fas fa-box', color: '#10b981' },
                'Collected': { icon: 'fas fa-box', color: '#10b981' },
                
                // 运输途中状态 - 对应上面的飞机图标
                'In Transit': { icon: 'fas fa-plane', color: '#f59e0b' },
                'Transit': { icon: 'fas fa-plane', color: '#f59e0b' },
                'Shipped': { icon: 'fas fa-plane', color: '#f59e0b' },
                
                // 清关状态 - 对应上面的护照图标
                'Customs': { icon: 'fas fa-passport', color: '#8b5cf6' },
                'Customs Clearance': { icon: 'fas fa-passport', color: '#8b5cf6' },
                'In Customs': { icon: 'fas fa-passport', color: '#8b5cf6' },
                
                // 异常状态 - 对应上面的三角警告图标
                'Exception': { icon: 'fas fa-exclamation-triangle', color: '#ef4444' },
                'Delayed': { icon: 'fas fa-exclamation-triangle', color: '#ef4444' },
                'Failed': { icon: 'fas fa-exclamation-triangle', color: '#ef4444' },
                'Error': { icon: 'fas fa-exclamation-triangle', color: '#ef4444' },
                
                // 末端配送状态 - 对应上面的卡车图标
                'Out for Delivery': { icon: 'fas fa-truck', color: '#f97316' },
                'Final Delivery': { icon: 'fas fa-truck', color: '#f97316' },
                'Delivery': { icon: 'fas fa-truck', color: '#f97316' },
                
                // 签收完成状态 - 对应上面的勾图标
                'Delivered': { icon: 'fas fa-check-circle', color: '#22c55e' },
                'Completed': { icon: 'fas fa-check-circle', color: '#22c55e' },
                'Signed': { icon: 'fas fa-check-circle', color: '#22c55e' }
            };
            
            // 首先尝试完全匹配
            if (statusMap[status]) {
                return statusMap[status];
            }
            
            // 如果没有完全匹配，尝试部分匹配
            for (const [key, value] of Object.entries(statusMap)) {
                if (status && status.toLowerCase().includes(key.toLowerCase())) {
                    return value;
                }
            }
            
            // 默认返回信息录入状态
            return { icon: 'fas fa-file-alt', color: '#3b82f6' };
        }

        // 切换详情显示
        function toggleDetails(index) {
            const details = document.getElementById(`details-${index}`);
            const toggleBtn = document.getElementById(`toggle-btn-${index}`);
            
            if (details && toggleBtn) {
                const isExpanded = details.classList.contains('expanded');
                
                if (isExpanded) {
                    // 收起详情
                    details.classList.remove('expanded');
                    toggleBtn.classList.remove('expanded');
                    toggleBtn.querySelector('.toggle-symbol').textContent = '▼';
                    toggleBtn.title = '展开详细信息';
                } else {
                    // 展开详情
                    details.classList.add('expanded');
                    toggleBtn.classList.add('expanded');
                    toggleBtn.querySelector('.toggle-symbol').textContent = '▲';
                    toggleBtn.title = '收起详细信息';
                }
            }
        }

        // 添加状态栏横线效果
        function addStatusBarHoverEffect() {
            const statusTabs = document.querySelectorAll('.status-tab');
            const summaryContent = document.querySelector('.summary-content');
            
            if (!summaryContent) return;
            
            statusTabs.forEach(tab => {
                tab.addEventListener('mouseenter', function() {
                    const tabRect = this.getBoundingClientRect();
                    const containerRect = summaryContent.getBoundingClientRect();
                    
                    const left = tabRect.left - containerRect.left;
                    const width = tabRect.width;
                    
                    summaryContent.style.setProperty('--line-left', left + 'px');
                    summaryContent.style.setProperty('--line-width', width + 'px');
                    summaryContent.classList.add('show-line');
                });
                
                tab.addEventListener('mouseleave', function() {
                    summaryContent.classList.remove('show-line');
                });
            });
        }

        // 显示承运商菜单
        function showCarrierMenu(element, carrier) {
            // 先隐藏所有其他菜单
            document.querySelectorAll('.carrier-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            
            const carrierInfo = element.closest('.carrier-info');
            const menu = carrierInfo.querySelector('.carrier-menu');
            if (menu) {
                menu.classList.add('show');
            }
        }

        // 隐藏承运商菜单
        function hideCarrierMenu(carrierInfo) {
            const menu = carrierInfo.querySelector('.carrier-menu');
            if (menu) {
                menu.classList.remove('show');
            }
        }

        // 点击其他地方时隐藏所有菜单
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.carrier-info')) {
                document.querySelectorAll('.carrier-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // 服务商数据
        const carrierData = {
            '国际快递': [
                { name: 'DHL Express', website: 'https://www.dhl.com/express', icon: 'DHL' },
                { name: 'UPS', website: 'https://www.ups.com', icon: 'UPS' },
                { name: 'FedEx', website: 'https://www.fedex.com', icon: 'FDX' },
                { name: 'TNT', website: 'https://www.tnt.com', icon: 'TNT' },
                { name: 'USPS', website: 'https://www.usps.com', icon: 'USPS' },
                { name: 'EMS', website: 'https://www.ems.com.cn', icon: 'EMS' },
                { name: 'China Post', website: 'https://www.chinapost.com.cn', icon: 'CP' }
            ],
            '国内快递': [
                { name: '顺丰', website: 'https://www.sf-express.com', icon: 'SF' },
                { name: '中通', website: 'https://www.zto.com', icon: 'ZTO' },
                { name: '圆通', website: 'https://www.yto.net.cn', icon: 'YTO' },
                { name: '申通', website: 'https://www.sto.cn', icon: 'STO' },
                { name: '韵达', website: 'https://www.yunda.com', icon: 'YD' },
                { name: '京东', website: 'https://www.jd.com', icon: 'JD' }
            ],
            '航空公司': [
                { name: 'Air China', website: 'https://www.airchina.com.cn', icon: 'CA' },
                { name: 'China Eastern', website: 'https://www.ceair.com', icon: 'MU' },
                { name: 'China Southern', website: 'https://www.csair.com', icon: 'CZ' },
                { name: 'Hainan Airlines', website: 'https://www.hainanairlines.com', icon: 'HU' },
                { name: 'Shenzhen Airlines', website: 'https://www.shenzhenair.com', icon: 'ZH' },
                { name: 'Xiamen Airlines', website: 'https://www.xiamenair.com', icon: 'MF' }
            ],
            '船运公司': [
                { name: 'COSCO Shipping', website: 'https://www.cosco-shipping.com', icon: 'COSCO' },
                { name: 'OOCL', website: 'https://www.oocl.com', icon: 'OOCL' },
                { name: 'Evergreen', website: 'https://www.evergreen-marine.com', icon: 'EMC' },
                { name: 'Maersk', website: 'https://www.maersk.com', icon: 'MSK' },
                { name: 'CMA CGM', website: 'https://www.cma-cgm.com', icon: 'CMA' },
                { name: 'Hapag-Lloyd', website: 'https://www.hapag-lloyd.com', icon: 'HPL' }
            ]
        };

        // 全局变量存储当前查询的单号
        let currentTrackingNumber = '';

        // 打开服务商选择弹窗
        function openCarrierModal(trackingNumber) {
            const modal = document.getElementById('carrierModal');
            modal.classList.add('show');
            currentTrackingNumber = trackingNumber || '';
            
            // 显示或隐藏当前选择信息
            const currentSelection = document.getElementById('currentSelection');
            if (currentTrackingNumber) {
                currentSelection.style.display = 'block';
                document.querySelector('.tracking-number-display').textContent = currentTrackingNumber;
            } else {
                currentSelection.style.display = 'none';
            }
            
            renderCarriers();
            document.body.style.overflow = 'hidden';
        }

        // 关闭服务商选择弹窗
        function closeCarrierModal() {
            const modal = document.getElementById('carrierModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            // 清空搜索框
            document.querySelector('.carrier-search-box').value = '';
            currentTrackingNumber = '';
        }

        // 更新状态统计信息
        function updateStatusSummary() {
            const resultItems = document.querySelectorAll('.result-item');
            const statusCounts = {
                total: resultItems.length,
                info: 0,
                pickup: 0,
                transit: 0,
                customs: 0,
                exception: 0,
                delivery: 0,
                delivered: 0,
                analysis: 0
            };

            resultItems.forEach(item => {
                if (item.classList.contains('error-item')) {
                    statusCounts.exception++;
                } else {
                    // 根据状态文本来判断分类
                    const statusText = item.querySelector('.status-text')?.textContent || '';
                    if (statusText.includes('运输中') || statusText.includes('In Transit')) {
                        statusCounts.transit++;
                    } else if (statusText.includes('已签收') || statusText.includes('Delivered')) {
                        statusCounts.delivered++;
                    } else if (statusText.includes('派送') || statusText.includes('配送')) {
                        statusCounts.delivery++;
                    } else if (statusText.includes('清关')) {
                        statusCounts.customs++;
                    } else if (statusText.includes('收件') || statusText.includes('取件')) {
                        statusCounts.pickup++;
                    } else {
                        statusCounts.info++;
                    }
                }
            });

            // 更新统计显示
            const statusSummary = document.getElementById('statusSummary');
            if (statusSummary) {
                const tabs = statusSummary.querySelectorAll('.status-tab .count');
                if (tabs.length >= 8) {
                    tabs[0].textContent = statusCounts.total;
                    tabs[1].textContent = statusCounts.info;
                    tabs[2].textContent = statusCounts.pickup;
                    tabs[3].textContent = statusCounts.transit;
                    tabs[4].textContent = statusCounts.customs;
                    tabs[5].textContent = statusCounts.exception;
                    tabs[6].textContent = statusCounts.delivery;
                    tabs[7].textContent = statusCounts.delivered;
                }
            }
        }

        // 选择服务商并重新查询
        async function selectCarrierAndQuery(carrierName, trackingNumber) {
            closeCarrierModal();
            
            if (!trackingNumber) {
                alert('无效的单号');
                return;
            }
            
            // 找到对应的结果行
            const resultItems = document.querySelectorAll('.result-item');
            let targetResultItem = null;
            let resultIndex = -1;
            
            resultItems.forEach((item, index) => {
                const trackingSpan = item.querySelector('.tracking-number');
                if (trackingSpan && trackingSpan.textContent.trim() === trackingNumber) {
                    targetResultItem = item;
                    resultIndex = index;
                }
            });
            
            if (!targetResultItem) {
                alert('找不到对应的结果行');
                return;
            }
            
            // 显示该行的加载状态
            targetResultItem.innerHTML = `
                <div class="result-content">
                    <div class="result-left">
                        <div class="status-section">
                            <div class="status-icon-pure" style="color: #3b82f6">
                                <div class="spinner-small"></div>
                            </div>
                            <div class="status-text-info">
                                <div class="status-text-line">
                                    <div class="status-text">查询中...</div>
                                    <div class="status-time">--</div>
                                </div>
                                <div class="tracking-section">
                                    <div class="tracking-number">${trackingNumber}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="result-middle">
                        <div class="carrier-info">
                            <div class="carrier-name">正在使用 ${carrierName} 查询...</div>
                        </div>
                        <div class="location-info">
                            <span class="loading-message">请稍候...</span>
                        </div>
                    </div>
                    <div class="result-right">
                        <div class="status-info">
                            <div class="last-update">查询中</div>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                // 调用后端API，强制使用指定的服务商
                const response = await fetch('/api/tracking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trackingNumbers: [trackingNumber],
                        forcedCarrier: carrierName
                    })
                });
                
                if (!response.ok) {
                    throw new Error('网络请求失败');
                }
                
                const data = await response.json();
                
                // 更新该行的结果
                if (data.results && data.results.length > 0) {
                    const result = data.results[0];
                    
                    // 更新结果项的类名
                    if (result.success) {
                        targetResultItem.className = 'result-item';
                        targetResultItem.setAttribute('onclick', `toggleDetails(${resultIndex})`);
                    } else {
                        targetResultItem.className = 'result-item error-item';
                        targetResultItem.setAttribute('onclick', `toggleDetails(${resultIndex})`);
                    }
                    
                    // 重新渲染这一行的主要内容
                    targetResultItem.innerHTML = createResultItemHTML(result, resultIndex);
                    
                    // 更新或创建详细信息部分
                    let detailsElement = document.getElementById(`details-${resultIndex}`);
                    if (detailsElement) {
                        detailsElement.innerHTML = createDetailsHTML(result, resultIndex);
                    } else if (result.events) {
                        // 如果没有详细信息元素但有事件数据，创建一个
                        detailsElement = document.createElement('div');
                        detailsElement.id = `details-${resultIndex}`;
                        detailsElement.className = 'result-details';
                        detailsElement.innerHTML = createDetailsHTML(result, resultIndex);
                        targetResultItem.parentNode.insertBefore(detailsElement, targetResultItem.nextSibling);
                    }
                    
                    // 重新计算和更新统计信息
                    updateStatusSummary();
                } else {
                    throw new Error('查询结果为空');
                }
                
            } catch (error) {
                console.error('查询错误:', error);
                
                // 显示错误状态
                targetResultItem.className = 'result-item error-item';
                targetResultItem.setAttribute('onclick', `toggleDetails(${resultIndex})`);
                targetResultItem.innerHTML = createResultItemHTML({
                    success: false,
                    trackingNumber: trackingNumber,
                    message: `使用 ${carrierName} 查询失败：${error.message}`
                }, resultIndex);
                
                // 重新计算和更新统计信息
                updateStatusSummary();
            }
        }

        // 渲染服务商列表
        function renderCarriers(searchTerm = '') {
            const modalBody = document.getElementById('carrierModalBody');
            let html = '';
            let hasResults = false;

            Object.entries(carrierData).forEach(([category, carriers]) => {
                const filteredCarriers = carriers.filter(carrier => 
                    carrier.name.toLowerCase().includes(searchTerm.toLowerCase())
                );

                if (filteredCarriers.length > 0) {
                    hasResults = true;
                    html += `
                        <div class="carrier-category">
                            <div class="carrier-category-title">${category}</div>
                            <div class="carrier-grid">
                                ${filteredCarriers.map(carrier => `
                                    <a href="${currentTrackingNumber ? '#' : carrier.website}" ${currentTrackingNumber ? '' : 'target="_blank"'} class="carrier-item" onclick="${currentTrackingNumber ? `selectCarrierAndQuery('${carrier.name}', '${currentTrackingNumber}')` : 'closeCarrierModal()'}">
                                        <div class="carrier-item-icon">${carrier.icon}</div>
                                        <div class="carrier-item-name">${carrier.name}</div>
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            if (!hasResults) {
                html = '<div class="carrier-no-results">未找到相关运输商</div>';
            }

            modalBody.innerHTML = html;
        }

        // 搜索服务商
        function filterCarriers(searchTerm) {
            renderCarriers(searchTerm);
        }

        // 点击弹窗外部关闭
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('carrierModal');
            if (e.target === modal) {
                closeCarrierModal();
            }
        });

        // ESC键关闭弹窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCarrierModal();
            }
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            addStatusBarHoverEffect();
            initializeUserLogin();
        });

        // 初始化用户登录状态
        function initializeUserLogin() {
            // 检查本地存储的登录状态
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    
                    // 更新通知弹窗中的登录按钮
                    updateLoginButton();
                } catch (e) {
                    // 如果解析失败，清除错误的数据
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // 更新登录按钮状态
        function updateLoginButton() {
            const notifyLoginBtn = document.querySelector('.notify-login-btn');
            if (notifyLoginBtn) {
                if (isLoggedIn) {
                    notifyLoginBtn.textContent = '个人中心';
                } else {
                    notifyLoginBtn.textContent = '登录/注册';
                }
            }
        }

        // 保存用户登录状态到本地存储
        function saveUserLogin(user) {
            localStorage.setItem('currentUser', JSON.stringify(user));
        }

        // 清除用户登录状态
        function clearUserLogin() {
            localStorage.removeItem('currentUser');
            isLoggedIn = false;
            currentUser = null;
        }

        // 通知弹窗逻辑
        let notifyTrackingNumber = '';
        let emailCount = 1;
        let isLoggedIn = false; // 模拟登录状态
        let currentUser = null; // 当前用户信息
        
        function openNotifyModal(trackingNumber) {
            notifyTrackingNumber = trackingNumber;
            document.getElementById('notifyModal').classList.add('show');
            
            // 如果已登录，自动填充邮箱
            if (isLoggedIn && currentUser) {
                document.getElementById('notifyEmail1').value = currentUser.email;
                handleEmailInput(1);
            }
            
            // 更新登录按钮状态
            updateLoginButton();
            
            // 检查是否为查询失败的单号，添加特殊提示
            const isFailedTracking = document.querySelector(`[onclick*="${trackingNumber}"]`)?.closest('.result-item')?.classList.contains('error-item');
            const subtitle = document.querySelector('.notify-modal-subtitle');
            
            if (isFailedTracking) {
                subtitle.textContent = '该单号暂无法识别，但您仍可设置通知，有更新时会及时通知您';
                subtitle.style.color = '#f59e0b';
            } else {
                subtitle.textContent = '我们该如何发送更新？';
                subtitle.style.color = '';
            }
            
            // 隐藏充值提醒（只在提交时检查）
            const quotaWarning = document.getElementById('quotaWarning');
            quotaWarning.style.display = 'none';
        }
        
        function closeNotifyModal() {
            document.getElementById('notifyModal').classList.remove('show');
            // 重置表单
            resetForm();
        }
        
        function hideQuotaWarning() {
            const quotaWarning = document.getElementById('quotaWarning');
            quotaWarning.style.display = 'none';
        }
        
        function resetForm() {
            emailCount = 1;
            document.querySelector('.notify-emails-container').innerHTML = `
                <div class="email-input-group" id="emailGroup1">
                    <div class="email-input-row">
                        <input type="email" id="notifyEmail1" placeholder="请输入邮箱地址" class="notify-email-input" oninput="handleEmailInput(1)">
                        <button class="email-remove-btn" onclick="removeEmail(1)" style="display: none;"></button>
                    </div>
                    <div class="email-error-message" id="emailError1"></div>
                </div>
            `;
            document.getElementById('addEmailBtn').style.display = 'none';
            
            // 隐藏充值提醒
            hideQuotaWarning();
        }
        
        // 邮箱验证函数
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function handleEmailInput(id) {
            const emailInput = document.getElementById(`notifyEmail${id}`);
            const removeBtn = emailInput.parentElement.querySelector('.email-remove-btn');
            const errorMessage = document.getElementById(`emailError${id}`);
            const addBtn = document.getElementById('addEmailBtn');
            const emailValue = emailInput.value.trim();
            
            // 清除之前的验证状态
            emailInput.classList.remove('error', 'valid');
            errorMessage.classList.remove('show');
            errorMessage.textContent = '';
            
            // 用户开始输入时隐藏充值提醒，给用户更好的体验
            if (emailValue) {
                hideQuotaWarning();
            }
            
            if (emailValue) {
                // 验证邮箱格式
                if (validateEmail(emailValue)) {
                    // 邮箱格式正确
                    emailInput.classList.add('valid');
                    removeBtn.style.display = 'flex';
                    addBtn.style.display = 'flex';
                } else {
                    // 邮箱格式错误
                    emailInput.classList.add('error');
                    errorMessage.textContent = '请输入有效的邮箱地址';
                    errorMessage.classList.add('show');
                    removeBtn.style.display = 'flex';
                    addBtn.style.display = 'flex';
                }
            } else {
                // 邮箱为空
                removeBtn.style.display = 'none';
                // 检查是否还有其他邮箱输入，如果没有则隐藏添加按钮
                const allEmails = document.querySelectorAll('.notify-email-input');
                let hasValue = false;
                allEmails.forEach(input => {
                    if (input.value.trim()) hasValue = true;
                });
                if (!hasValue) {
                    addBtn.style.display = 'none';
                }
            }
        }
        
        function addEmailInput() {
            if (emailCount >= 5) {
                alert('最多只能添加5个通知人');
                return;
            }
            
            emailCount++;
            const container = document.querySelector('.notify-emails-container');
            const newEmailGroup = document.createElement('div');
            newEmailGroup.className = 'email-input-group';
            newEmailGroup.id = `emailGroup${emailCount}`;
            newEmailGroup.innerHTML = `
                <div class="email-input-row">
                    <input type="email" id="notifyEmail${emailCount}" placeholder="请输入邮箱地址" class="notify-email-input" oninput="handleEmailInput(${emailCount})">
                    <button class="email-remove-btn" onclick="removeEmail(${emailCount})"></button>
                </div>
                <div class="email-error-message" id="emailError${emailCount}"></div>
            `;
            container.appendChild(newEmailGroup);
        }
        
        function removeEmail(id) {
            const emailGroup = document.getElementById(`emailGroup${id}`);
            if (emailGroup && emailCount > 1) {
                emailGroup.remove();
                emailCount--;
                
                // 检查是否还有邮箱输入，如果没有则隐藏添加按钮
                const allEmails = document.querySelectorAll('.notify-email-input');
                let hasValue = false;
                allEmails.forEach(input => {
                    if (input.value.trim()) hasValue = true;
                });
                if (!hasValue) {
                    document.getElementById('addEmailBtn').style.display = 'none';
                }
            }
        }
        
        function showLogin() {
            if (isLoggedIn) {
                // 如果已登录，显示个人中心
                openUserCenterModal();
            } else {
                // 显示登录弹窗
                openLoginModal();
            }
        }

        // 退出登录
        function logout() {
            // 确认退出登录
            const confirmLogout = confirm('确定要退出登录吗？');
            if (!confirmLogout) {
                return;
            }
            
            clearUserLogin();
            
            // 关闭个人中心弹窗
            closeUserCenterModal();
            
            // 更新通知弹窗中的登录按钮
            updateLoginButton();
            
            // 清空通知弹窗中的邮箱输入
            if (document.getElementById('notifyModal').classList.contains('show')) {
                document.getElementById('notifyEmail1').value = '';
                handleEmailInput(1);
            }
            
            alert('已退出登录');
        }
        
        function showRecharge() {
            // 从通知弹窗中的充值按钮调用
            showRechargeModal();
        }
        
        function checkQuotaOnSubmit() {
            // 模拟检查额度，30%概率返回数量不足
            const hasEnoughQuota = Math.random() > 0.3; // 30%概率数量不足
            
            return hasEnoughQuota;
        }
        
        function submitNotify() {
            // 获取所有通知人邮箱并验证
            const emails = [];
            const emailInputs = document.querySelectorAll('.notify-email-input');
            let hasInvalidEmail = false;
            
            emailInputs.forEach(input => {
                const emailValue = input.value.trim();
                if (emailValue) {
                    if (validateEmail(emailValue)) {
                        emails.push(emailValue);
                    } else {
                        hasInvalidEmail = true;
                        // 标记输入框为错误状态
                        input.classList.add('error');
                        input.classList.remove('valid');
                        const errorMessage = input.parentElement.nextElementSibling;
                        errorMessage.textContent = '请输入有效的邮箱地址';
                        errorMessage.classList.add('show');
                    }
                }
            });
            
            if (emails.length === 0) {
                alert('请至少输入一个邮箱地址');
                return;
            }
            
            if (hasInvalidEmail) {
                alert('请检查并修正无效的邮箱地址');
                return;
            }
            
            // 获取选中的通知类型
            const selectedTypes = [];
            const checkboxes = document.querySelectorAll('.notify-type-option input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedTypes.push(checkbox.nextSibling.textContent.trim());
            });
            
            if (selectedTypes.length === 0) {
                alert('请选择至少一种通知类型');
                return;
            }
            
            // 在提交时检查数量是否足够
            const hasEnoughQuota = checkQuotaOnSubmit();
            
            if (!hasEnoughQuota) {
                // 显示充值提醒
                const quotaWarning = document.getElementById('quotaWarning');
                quotaWarning.style.display = 'block';
                
                // 滚动到充值提醒位置
                quotaWarning.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            // 调用注册通知API
            submitNotificationRegistration(emails, selectedTypes);
        }

        // 提交通知注册
        function submitNotificationRegistration(emails, selectedTypes) {
            // 转换通知类型为英文
            const typeMapping = {
                '包裹已收件': 'pickup',
                '运输途中': 'transit', 
                '到达目的地': 'delivery',
                '清关状态': 'customs',
                '正在配送': 'delivery',
                '投递完成': 'delivered',
                '异常/延误': 'exception'
            };
            
            const notificationTypes = selectedTypes.map(type => typeMapping[type] || 'transit');
            
            // 为每个邮箱发送注册请求
            const registrationPromises = emails.map(email => {
                return fetch('/api/notifications/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trackingNumber: notifyTrackingNumber,
                        email: email,
                        notificationTypes: notificationTypes
                    })
                });
            });
            
            Promise.all(registrationPromises)
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(results => {
                    const successCount = results.filter(r => r.success).length;
                    const failCount = results.length - successCount;
                    
                    if (successCount > 0) {
                        let message = `成功为 ${successCount} 个邮箱注册通知！`;
                        if (failCount > 0) {
                            message += `\n其中 ${failCount} 个邮箱注册失败。`;
                        }
                        message += '\n当包裹状态更新时，我们会发送邮件通知。';
                        alert(message);
                        closeNotifyModal();
                    } else {
                        alert('注册失败，请稍后重试。');
                    }
                })
                .catch(error => {
                    console.error('注册通知失败:', error);
                    alert('注册失败，请检查网络连接后重试。');
                });
        }
        
        // ESC关闭弹窗
        window.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('userCenterModal').classList.contains('show')) {
                    closeUserCenterModal();
                } else if (document.getElementById('loginModal').classList.contains('show')) {
                    closeLoginModal();
                } else if (document.getElementById('notifyModal').classList.contains('show')) {
                    closeNotifyModal();
                }
            }
        });
        
        // 点击弹窗外部关闭
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('notifyModal');
            if (modal && modal.classList.contains('show') && e.target === modal) closeNotifyModal();
            
            const loginModal = document.getElementById('loginModal');
            if (loginModal && loginModal.classList.contains('show') && e.target === loginModal) closeLoginModal();
            
            const userCenterModal = document.getElementById('userCenterModal');
            if (userCenterModal && userCenterModal.classList.contains('show') && e.target === userCenterModal) closeUserCenterModal();
        });

        // 登录/注册弹窗功能
        function openLoginModal(mode = 'login') {
            const modal = document.getElementById('loginModal');
            modal.classList.add('show');
            
            // 根据模式显示不同的表单
            if (mode === 'register') {
                showRegisterForm();
            } else if (mode === 'forgot') {
                showForgotPassword();
            } else {
                showLoginForm();
            }
            
            document.body.style.overflow = 'hidden';
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            
            // 清空表单
            clearAuthForms();
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('loginTitle').textContent = '登录';
            document.querySelector('.login-modal-subtitle').textContent = '登录后可自动填充邮箱，管理通知设置';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'flex';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('loginTitle').textContent = '注册';
            document.querySelector('.login-modal-subtitle').textContent = '注册账号享受更好的通知服务';
        }

        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'flex';
            document.getElementById('loginTitle').textContent = '重置密码';
            document.querySelector('.login-modal-subtitle').textContent = '输入您的邮箱地址，我们将发送重置链接';
        }

        function clearAuthForms() {
            // 清空所有表单
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('forgotEmail').value = '';
            document.getElementById('agreeTerms').checked = false;
            
            // 清除错误提示
            document.querySelectorAll('.input-error').forEach(error => {
                error.classList.remove('show');
                error.textContent = '';
            });
            
            // 清除输入框样式
            document.querySelectorAll('.form-input').forEach(input => {
                input.classList.remove('error', 'valid');
            });
        }

        // 密码显示/隐藏
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const eye = document.getElementById(inputId + 'Eye');
            
            if (input.type === 'password') {
                input.type = 'text';
                eye.classList.remove('fa-eye');
                eye.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                eye.classList.remove('fa-eye-slash');
                eye.classList.add('fa-eye');
            }
        }

        // 邮箱验证
        function validateLoginEmail() {
            const email = document.getElementById('loginEmail').value.trim();
            const input = document.getElementById('loginEmail');
            const error = document.getElementById('loginEmailError');
            
            if (email && !validateEmail(email)) {
                input.classList.add('error');
                input.classList.remove('valid');
                error.textContent = '请输入有效的邮箱地址';
                error.classList.add('show');
                return false;
            } else if (email) {
                input.classList.add('valid');
                input.classList.remove('error');
                error.classList.remove('show');
                return true;
            } else {
                input.classList.remove('error', 'valid');
                error.classList.remove('show');
                return false;
            }
        }

        function validateRegisterEmail() {
            const email = document.getElementById('registerEmail').value.trim();
            const input = document.getElementById('registerEmail');
            const error = document.getElementById('registerEmailError');
            
            if (email && !validateEmail(email)) {
                input.classList.add('error');
                input.classList.remove('valid');
                error.textContent = '请输入有效的邮箱地址';
                error.classList.add('show');
                return false;
            } else if (email) {
                input.classList.add('valid');
                input.classList.remove('error');
                error.classList.remove('show');
                return true;
            } else {
                input.classList.remove('error', 'valid');
                error.classList.remove('show');
                return false;
            }
        }

        function validateRegisterPassword() {
            const password = document.getElementById('registerPassword').value;
            const input = document.getElementById('registerPassword');
            const error = document.getElementById('registerPasswordError');
            
            if (password.length > 0 && password.length < 6) {
                input.classList.add('error');
                input.classList.remove('valid');
                error.textContent = '密码至少需要6位';
                error.classList.add('show');
                return false;
            } else if (password.length >= 6) {
                input.classList.add('valid');
                input.classList.remove('error');
                error.classList.remove('show');
                return true;
            } else {
                input.classList.remove('error', 'valid');
                error.classList.remove('show');
                return false;
            }
        }

        function validateConfirmPassword() {
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const input = document.getElementById('confirmPassword');
            const error = document.getElementById('confirmPasswordError');
            
            if (confirmPassword && password !== confirmPassword) {
                input.classList.add('error');
                input.classList.remove('valid');
                error.textContent = '两次输入的密码不一致';
                error.classList.add('show');
                return false;
            } else if (confirmPassword && password === confirmPassword) {
                input.classList.add('valid');
                input.classList.remove('error');
                error.classList.remove('show');
                return true;
            } else {
                input.classList.remove('error', 'valid');
                error.classList.remove('show');
                return false;
            }
        }

        function validateForgotEmail() {
            const email = document.getElementById('forgotEmail').value.trim();
            const input = document.getElementById('forgotEmail');
            const error = document.getElementById('forgotEmailError');
            
            if (email && !validateEmail(email)) {
                input.classList.add('error');
                input.classList.remove('valid');
                error.textContent = '请输入有效的邮箱地址';
                error.classList.add('show');
                return false;
            } else if (email) {
                input.classList.add('valid');
                input.classList.remove('error');
                error.classList.remove('show');
                return true;
            } else {
                input.classList.remove('error', 'valid');
                error.classList.remove('show');
                return false;
            }
        }

        // 登录
        function submitLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('请填写完整的登录信息');
                return;
            }
            
            if (!validateLoginEmail()) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            // 模拟登录请求
            const loginBtn = document.querySelector('#loginForm .auth-submit-btn');
            loginBtn.disabled = true;
            loginBtn.textContent = '登录中...';
            
                         // 模拟API调用
            setTimeout(() => {
                // 模拟登录成功
                isLoggedIn = true;
                currentUser = {
                    email: email,
                    username: email.split('@')[0],
                    registerDate: '2024年1月15日 14:30:25' // 模拟注册时间
                };
                
                // 保存登录状态到本地存储
                saveUserLogin(currentUser);
                
                // 更新通知弹窗中的登录按钮
                updateLoginButton();
                
                // 如果通知弹窗是打开的，自动填充邮箱
                if (document.getElementById('notifyModal').classList.contains('show')) {
                    document.getElementById('notifyEmail1').value = email;
                    handleEmailInput(1);
                }
                
                alert('登录成功！');
                closeLoginModal();
                
                loginBtn.disabled = false;
                loginBtn.textContent = '登录';
            }, 1000);
        }

        // 注册
        function submitRegister() {
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            
            if (!email || !password || !confirmPassword) {
                alert('请填写完整的注册信息');
                return;
            }
            
            if (!validateRegisterEmail()) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            if (!validateRegisterPassword()) {
                alert('密码至少需要6位');
                return;
            }
            
            if (!validateConfirmPassword()) {
                alert('两次输入的密码不一致');
                return;
            }
            
            if (!agreeTerms) {
                alert('请同意用户协议和隐私政策');
                return;
            }
            
            // 模拟注册请求
            const registerBtn = document.querySelector('#registerForm .auth-submit-btn');
            registerBtn.disabled = true;
            registerBtn.textContent = '注册中...';
            
                         // 模拟API调用
            setTimeout(() => {
                // 模拟注册成功后自动登录
                isLoggedIn = true;
                currentUser = {
                    email: email,
                    username: email.split('@')[0],
                    registerDate: new Date().toLocaleString('zh-CN') // 注册时间为当前时间
                };
                
                // 保存登录状态到本地存储
                saveUserLogin(currentUser);
                
                // 更新通知弹窗中的登录按钮
                updateLoginButton();
                
                // 如果通知弹窗是打开的，自动填充邮箱
                if (document.getElementById('notifyModal').classList.contains('show')) {
                    document.getElementById('notifyEmail1').value = email;
                    handleEmailInput(1);
                }
                
                alert('注册成功！已为您自动登录');
                closeLoginModal();
                
                registerBtn.disabled = false;
                registerBtn.textContent = '注册';
            }, 1000);
        }

        // 忘记密码
        function submitForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            
            if (!email) {
                alert('请输入您的邮箱地址');
                return;
            }
            
            if (!validateForgotEmail()) {
                alert('请输入有效的邮箱地址');
                return;
            }
            
            // 模拟发送重置邮件
            const forgotBtn = document.querySelector('#forgotPasswordForm .auth-submit-btn');
            forgotBtn.disabled = true;
            forgotBtn.textContent = '发送中...';
            
            // 模拟API调用
            setTimeout(() => {
                alert(`重置密码邮件已发送至 ${email}，请检查您的邮箱`);
                showLoginForm();
                
                forgotBtn.disabled = false;
                forgotBtn.textContent = '发送重置邮件';
            }, 1000);
        }

        // 显示用户协议
        function showTerms() {
            alert('用户协议内容（待完善）');
        }

        // 显示隐私政策
        function showPrivacy() {
            alert('隐私政策内容（待完善）');
        }

        // 个人中心弹窗管理
        function openUserCenterModal() {
            const modal = document.getElementById('userCenterModal');
            modal.classList.add('show');
            
            // 更新用户信息显示
            if (currentUser) {
                document.getElementById('userEmailDisplay').textContent = currentUser.email;
                
                // 设置注册时间（模拟）
                const registerDate = currentUser.registerDate || new Date().toLocaleString('zh-CN');
                document.getElementById('userMemberSince').textContent = `注册时间：${registerDate}`;
                
                // 模拟用户数据更新
                updateUserCenterData();
            }
            
            document.body.style.overflow = 'hidden';
        }

        function closeUserCenterModal() {
            const modal = document.getElementById('userCenterModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // 更新个人中心数据
        function updateUserCenterData() {
            // 模拟用户数据
            const userData = {
                notifyCount: Math.floor(Math.random() * 200 + 50),
                totalUsed: Math.floor(Math.random() * 100 + 20),
                totalQueries: Math.floor(Math.random() * 500 + 100),
                totalNotifications: Math.floor(Math.random() * 100 + 10),
                monthlyQueries: Math.floor(Math.random() * 50 + 5),
                activeTracking: Math.floor(Math.random() * 20 + 1)
            };
            
            // 更新显示
            document.getElementById('notifyCount').textContent = userData.notifyCount;
            document.getElementById('totalUsed').textContent = userData.totalUsed;
            
            // 更新统计数据
            const statNumbers = document.querySelectorAll('.stat-number');
            if (statNumbers.length >= 4) {
                statNumbers[0].textContent = userData.totalQueries;
                statNumbers[1].textContent = userData.totalNotifications;
                statNumbers[2].textContent = userData.monthlyQueries;
                statNumbers[3].textContent = userData.activeTracking;
            }
        }

        // 显示充值弹窗
        function showRechargeModal() {
            alert('购买通知次数套餐\n\n可选择次数套餐：\n• 基础套餐 - 300次通知\n• 标准套餐 - 800次通知\n• 高级套餐 - 1800次通知\n• 企业套餐 - 5000次通知\n\n购买的次数永久有效，用完为止\n\n💡 温馨提示：建议选择标准套餐或以上，性价比更高！');
        }

        // 显示套餐购买弹窗
        function showPackageModal() {
            alert('购买更多通知次数\n\n可选择次数套餐：\n• 基础套餐 - 300次通知\n• 标准套餐 - 800次通知 + 短信支持\n• 高级套餐 - 1800次通知 + 短信支持\n• 企业套餐 - 5000次通知 + 短信支持 + API接口\n\n所有次数永久有效，用完为止');
        }

        // 显示完整历史记录
        function showFullHistory() {
            alert('完整历史记录功能开发中...\n\n将显示：\n• 所有次数购买记录\n• 套餐购买记录\n• 通知使用记录\n• 查询历史记录\n\n支持导出Excel文件');
        }

        // 输入框分隔符智能处理
        // 支持回车、空格、中文逗号、英文逗号都转成英文逗号
        const trackingInput = document.getElementById('trackingNumbers');
        trackingInput.addEventListener('input', function(e) {
            let value = e.target.value;
            // 把所有分隔符都转成英文逗号
            value = value.replace(/[\n\r\s，、]+/g, ',');
            // 连续逗号合并
            value = value.replace(/,+/g, ',');
            // 去除首尾逗号
            value = value.replace(/^,|,$/g, '');
            e.target.value = value;
            // 动态显示/隐藏按钮
            const inputActions = document.querySelector('.input-actions');
            if (e.target.value.trim()) {
                inputActions.classList.add('show');
            } else {
                inputActions.classList.remove('show');
            }
            // 更新数量显示
            updateTrackingCount();
        });

        // 创建单个结果项的主要内容HTML（不包含details）
        function createResultItemHTML(data, index) {
            if (!data.success) {
                return `
                    <div class="result-left">
                        <div class="status-section">
                            <div class="status-icon-pure" style="color: #ef4444">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="status-text-info">
                                <div class="status-text-line">
                                    <div class="status-text">查询不到</div>
                                    <div class="status-time">--</div>
                                </div>
                                <div class="tracking-section">
                                    <div class="tracking-number">${data.trackingNumber || '未知'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="result-middle">
                        <div class="carrier-info">
                            <div class="carrier-name error" onclick="event.stopPropagation(); openCarrierModal('${data.trackingNumber}')">选择服务商</div>
                        </div>
                        <div class="location-info">
                            <span class="error-message">
                                ${data.message || '无法识别该单号格式，请检查单号是否正确'}
                            </span>
                            <div class="notify-btn" title="订阅通知" onclick="openNotifyModal('${data.trackingNumber}')">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="delivery-info">
                                <!-- 错误状态下不显示预计到达时间和轨迹 -->
                            </div>
                        </div>
                    </div>
                    <div class="result-right">
                        <div class="status-info">
                            <div class="last-update">请确认单号是否正确</div>
                        </div>
                    </div>
                `;
            }

            const locationInfo = parseLocationInfo(data.events);
            const latestEvent = data.events && data.events[0];
            const carrierIcon = getCarrierIconClass(data.carrier);
            const carrierDisplayName = getCarrierDisplayName(data.carrier);
            const statusIconInfo = getStatusIconInfo(data.status);

            return `
                <div class="result-left">
                    <div class="status-section">
                        <div class="status-icon-pure" style="color: ${statusIconInfo.color}">
                            <i class="${statusIconInfo.icon}"></i>
                        </div>
                        <div class="status-text-info">
                            <div class="status-text-line">
                                <div class="status-text">${data.status}</div>
                                <div class="status-time">1天</div>
                            </div>
                            <div class="tracking-section">
                                <div class="tracking-number">${data.trackingNumber}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="result-middle">
                    <div class="carrier-info" onmouseleave="hideCarrierMenu(this)">
                        <div class="carrier-name" onmouseenter="showCarrierMenu(this, '${data.carrier}')">${carrierDisplayName}</div>
                        <div class="carrier-menu">
                            <a href="${getCarrierTrackingUrl(data.carrier, data.trackingNumber)}" target="_blank" class="carrier-menu-item" onclick="event.stopPropagation()">
                                <i class="fas fa-home"></i>
                                官网追踪
                            </a>
                            <a href="#" class="carrier-menu-item" onclick="event.stopPropagation(); openCarrierModal('${data.trackingNumber}')">
                                <i class="fas fa-truck"></i>
                                选择服务商
                            </a>
                        </div>
                    </div>
                    <div class="location-info">
                        <span class="location-from">${locationInfo.from}</span>
                        <span class="location-arrow">→</span>
                        <span class="location-to">${locationInfo.to}</span>
                        <div class="notify-btn" title="订阅通知" onclick="openNotifyModal('${data.trackingNumber}')">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="delivery-info">
                            ${getEstimatedDelivery(data) ? `
                                <div class="estimated-delivery" title="预计到达时间">
                                    <span class="delivery-label">预计到达时间:</span>
                                    <span class="delivery-date">${getEstimatedDelivery(data)}</span>
                                </div>
                            ` : ''}
                            ${latestEvent ? `
                                <div class="latest-event" title="${latestEvent.description}">
                                    <span class="event-description">${latestEvent.description}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="result-right">
                    <div class="toggle-details-btn" onclick="toggleDetails(${index}); event.stopPropagation();" id="toggle-btn-${index}" title="展开详细信息">
                        <span class="toggle-symbol">▼</span>
                    </div>
                </div>
            `;
        }

        // 创建详细信息HTML
        function createDetailsHTML(data, index) {
            if (!data.events) {
                return `<div class="no-tracking-info">暂无详细追踪信息</div>`;
            }

            return `
                <div class="tracking-details">
                    <div class="tracking-details-header">
                        <div class="carrier-icon-large ${getCarrierIconClass(data.carrier)}">
                            ${getCarrierDisplayName(data.carrier)}
                        </div>
                        <div class="tracking-details-title">
                            <div class="tracking-details-carrier">${data.carrier} - 中国 - 电话: ${getCarrierPhone(data.carrier)} - 同步时间: ${formatDetailTime(new Date())}</div>
                        </div>
                    </div>
                    <div class="tracking-timeline-container">
                        ${data.events.map((event, eventIndex) => `
                            <div class="tracking-timeline-item ${eventIndex === 0 ? 'latest' : ''}">
                                <div class="timeline-datetime">${formatDetailTime(event.timestamp)}</div>
                                <div class="timeline-location">${event.location || ''}</div>
                                <div class="timeline-description">${event.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

    </script>
</body>
</html> 